# DNSCloak CI/CD Workflow
# 
# Triggers:
# - Push to main: Runs tests/validation only
# - Tag v*.*.* : Creates a GitHub release
# - Tag v*.*.*-lit : Deploys to VM and creates release
#
name: CI/CD

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
      - 'v*.*.*-lit'
  pull_request:
    branches:
      - main

permissions:
  contents: write

jobs:
  # ============================================
  # Validate - Runs on all pushes
  # ============================================
  validate:
    name: Validate Script
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check script syntax
        run: |
          bash -n setup.sh
          echo "‚úì Script syntax is valid"

      - name: Shellcheck
        uses: ludeeus/action-shellcheck@master
        with:
          scandir: '.'
          severity: warning
        continue-on-error: true

      - name: Check for sensitive data
        run: |
          echo "Checking for potential sensitive data leaks..."
          
          # Check for hardcoded IPs (excluding examples and documentation)
          if grep -rE '\b([0-9]{1,3}\.){3}[0-9]{1,3}\b' --include="*.sh" . | grep -v '0\.0\.0\.0' | grep -v '127\.0\.0\.1' | grep -v 'YOUR' | grep -v 'example' | grep -v 'Example' | grep -v '#'; then
            echo "‚ö†Ô∏è Warning: Found potential hardcoded IP addresses"
          else
            echo "‚úì No hardcoded IPs found"
          fi
          
          # Check for potential secrets
          if grep -riE '(password|secret|api.?key|token)\s*=' --include="*.sh" . | grep -v 'example' | grep -v 'YOUR' | grep -v '#' | grep -v 'generate'; then
            echo "‚ö†Ô∏è Warning: Found potential hardcoded secrets"
          else
            echo "‚úì No hardcoded secrets found"
          fi
          
          echo "‚úì Sensitive data check complete"

  # ============================================
  # Release - Runs on version tags
  # ============================================
  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: validate
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # Check if this is a deploy tag
          if [[ "$VERSION" == *"-lit"* ]]; then
            echo "is_deploy=true" >> $GITHUB_OUTPUT
          else
            echo "is_deploy=false" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ steps.version.outputs.version }}
          body: |
            ## DNSCloak ${{ steps.version.outputs.version }}
            
            ### Installation
            ```bash
            bash <(curl -Ls https://raw.githubusercontent.com/behnamkhorsandian/DNSCloak/main/setup.sh)
            ```
            
            ### What's New
            See [README.md](https://github.com/behnamkhorsandian/DNSCloak#readme) for full documentation.
          draft: false
          prerelease: ${{ contains(steps.version.outputs.version, '-') && !contains(steps.version.outputs.version, '-lit') }}
          files: |
            setup.sh
            LICENSE
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Purge jsDelivr CDN Cache
        run: |
          echo "Purging jsDelivr CDN cache for SOS files..."
          
          # Purge SOS web client files
          curl -s -X POST "https://purge.jsdelivr.net/gh/behnamkhorsandian/DNSCloak@main/src/sos/www/app.js" || true
          curl -s -X POST "https://purge.jsdelivr.net/gh/behnamkhorsandian/DNSCloak@main/src/sos/www/index.html" || true
          curl -s -X POST "https://purge.jsdelivr.net/gh/behnamkhorsandian/DNSCloak@main/src/sos/relay.py" || true
          curl -s -X POST "https://purge.jsdelivr.net/gh/behnamkhorsandian/DNSCloak@main/src/sos/crypto.py" || true
          
          # Purge install scripts
          curl -s -X POST "https://purge.jsdelivr.net/gh/behnamkhorsandian/DNSCloak@main/services/sos/install.sh" || true
          curl -s -X POST "https://purge.jsdelivr.net/gh/behnamkhorsandian/DNSCloak@main/setup.sh" || true
          
          echo "‚úì CDN cache purged"

  # ============================================
  # Deploy - Runs only on -lit tags
  # ============================================
  deploy:
    name: Deploy to VM
    runs-on: ubuntu-latest
    needs: [validate, release]
    if: contains(github.ref, '-lit')
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/}
          echo "version=$VERSION" >> $GITHUB_OUTPUT

      - name: Deploy to VM
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VM_HOST }}
          username: ${{ secrets.VM_USER }}
          key: ${{ secrets.VM_SSH_KEY }}
          port: ${{ secrets.VM_SSH_PORT || 22 }}
          script: |
            echo "üöÄ Deploying DNSCloak ${{ steps.version.outputs.version }}"
            
            # Navigate to install directory or create it
            INSTALL_DIR="/opt/telegram-proxy"
            
            if [ -d "$INSTALL_DIR" ]; then
              echo "Updating existing installation..."
              cd "$INSTALL_DIR"
              
              # Backup current config
              if [ -f "config.py" ]; then
                cp config.py config.py.backup
                echo "‚úì Config backed up"
              fi
              
              # Pull latest mtprotoproxy (not DNSCloak repo)
              if [ -d ".git" ]; then
                git pull origin master || true
              fi
            fi
            
            # Download latest setup script
            echo "Downloading latest setup.sh..."
            curl -Ls https://raw.githubusercontent.com/behnamkhorsandian/DNSCloak/main/setup.sh -o /tmp/dnscloak-setup.sh
            chmod +x /tmp/dnscloak-setup.sh
            
            # Restart the service if it exists
            if systemctl is-active --quiet telegram-proxy; then
              echo "Restarting proxy service..."
              systemctl restart telegram-proxy
              echo "‚úì Service restarted"
            else
              echo "‚ÑπÔ∏è Service not running, skipping restart"
            fi
            
            echo "‚úÖ Deployment complete!"

      - name: Deployment notification
        run: |
          echo "‚úÖ Successfully deployed ${{ steps.version.outputs.version }} to VM"
          echo ""
          echo "The following actions were performed:"
          echo "  - Downloaded latest setup.sh to VM"
          echo "  - Backed up existing config (if any)"
          echo "  - Restarted telegram-proxy service"
