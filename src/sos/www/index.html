<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SOS - Emergency Secure Chat</title>
  <meta name="description" content="End-to-end encrypted chat rooms over DNS tunnel. Works even during internet blackouts.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ†˜</text></svg>">
  <style>
    /* ========================================
       SOS Emergency Chat - Minimal Dark Theme
       Matching DNSCloak design language
       ======================================== */
    
    :root {
      --font-main: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
      --bg-primary: #1a0a0a;
      --bg-secondary: #2a1515;
      --bg-tertiary: #3a2020;
      --bg-input: #251010;
      --text-primary: #e7e7e7;
      --text-secondary: #b0a0a0;
      --text-dim: #706060;
      --sos-red: #ff4444;
      --sos-red-dark: #cc2222;
      --sos-red-glow: rgba(255, 68, 68, 0.3);
      --sos-green: #44cc66;
      --sos-yellow: #e5c855;
      --border: #4a3030;
      --border-focus: #ff4444;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-main);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      min-height: 100dvh;
      font-size: 14px;
      overflow: hidden;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--sos-red); }
    
    /* App Container */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
    }
    
    /* Screen management */
    .screen { display: none; flex-direction: column; height: 100%; }
    .screen.active { display: flex; }
    
    /* ===== HEADER ===== */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .header-logo {
      color: var(--sos-red);
      font-size: 12px;
      line-height: 1.1;
      white-space: pre;
      margin-bottom: 4px;
    }
    
    .header-subtitle {
      color: var(--text-secondary);
      font-size: 11px;
    }
    
    /* ===== WELCOME SCREEN ===== */
    #welcome-screen .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px;
      gap: 20px;
    }
    
    .welcome-info {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      max-width: 320px;
    }
    
    .welcome-info .icon { font-size: 48px; margin-bottom: 12px; }
    .welcome-info h2 { color: var(--text-primary); margin-bottom: 8px; font-size: 16px; }
    
    .feature-list {
      margin-top: 16px;
      text-align: left;
      font-size: 11px;
    }
    
    .feature-list li {
      margin: 6px 0;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .feature-list .check { color: var(--sos-green); }
    
    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      max-width: 280px;
      padding: 14px 20px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    
    .btn:hover {
      border-color: var(--sos-red);
      background: var(--bg-tertiary);
    }
    
    .btn:active { transform: scale(0.98); }
    
    .btn-primary {
      background: var(--sos-red-dark);
      border-color: var(--sos-red);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--sos-red);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 280px;
    }
    
    /* ===== CREATE/JOIN SCREEN ===== */
    #setup-screen .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
      overflow-y: auto;
    }
    
    .setup-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 16px;
    }
    
    .setup-section h3 {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Room ID display */
    .room-id-display {
      display: flex;
      justify-content: center;
      gap: 8px;
      font-size: 28px;
      padding: 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .room-id-phonetic {
      text-align: center;
      color: var(--text-dim);
      font-size: 11px;
    }
    
    /* Emoji Picker */
    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .emoji-btn {
      aspect-ratio: 1;
      border: 1px solid var(--border);
      background: var(--bg-input);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .emoji-btn:hover { border-color: var(--sos-red); background: var(--bg-tertiary); }
    .emoji-btn.selected { border-color: var(--sos-red); background: var(--sos-red-dark); }
    
    .emoji-selected {
      display: flex;
      gap: 6px;
      font-size: 24px;
      padding: 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      min-height: 52px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .emoji-selected span {
      cursor: pointer;
      transition: transform 0.1s;
    }
    
    .emoji-selected span:hover { transform: scale(1.2); }
    
    /* Mode selector */
    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px 8px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-secondary);
      font-family: var(--font-main);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    
    .mode-btn:hover { border-color: var(--text-secondary); }
    .mode-btn.active {
      border-color: var(--sos-red);
      background: var(--sos-red-dark);
      color: white;
    }
    
    .mode-btn .icon { font-size: 16px; display: block; margin-bottom: 4px; }
    
    /* PIN display/input */
    .pin-display, .pin-input-group {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 12px 0;
    }
    
    .pin-digit {
      width: 36px;
      height: 44px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      font-size: 20px;
      text-align: center;
      color: var(--text-primary);
      font-family: var(--font-main);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pin-digit.filled { border-color: var(--sos-red); }
    
    input.pin-digit {
      outline: none;
    }
    
    input.pin-digit:focus {
      border-color: var(--sos-red);
      box-shadow: 0 0 0 2px var(--sos-red-glow);
    }
    
    .pin-timer {
      text-align: center;
      color: var(--sos-yellow);
      font-size: 11px;
      margin-top: 8px;
    }
    
    .pin-timer.fixed { color: var(--text-dim); }
    
    /* Status messages */
    .status {
      padding: 8px 12px;
      font-size: 11px;
      text-align: center;
      border: 1px solid;
    }
    
    .status.error {
      background: rgba(255, 68, 68, 0.1);
      border-color: var(--sos-red);
      color: var(--sos-red);
    }
    
    .status.success {
      background: rgba(68, 204, 102, 0.1);
      border-color: var(--sos-green);
      color: var(--sos-green);
    }
    
    .status.info {
      background: rgba(229, 200, 85, 0.1);
      border-color: var(--sos-yellow);
      color: var(--sos-yellow);
    }
    
    /* Footer actions */
    .setup-actions {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .setup-actions .btn { max-width: none; }
    
    /* ===== CHAT SCREEN ===== */
    #chat-screen {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    #chat-screen.active { display: flex; }
    
    .chat-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    
    .chat-room-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-room-emojis { font-size: 14px; }
    
    .chat-room-meta {
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .chat-room-meta .expiry { color: var(--sos-yellow); }
    
    .chat-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
    }
    
    .status-dot.connected { background: var(--sos-green); }
    .status-dot.error { background: var(--sos-red); }
    
    /* Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .message {
      max-width: 85%;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      font-size: 13px;
      word-wrap: break-word;
    }
    
    .message.own {
      align-self: flex-end;
      background: var(--sos-red-dark);
      border-color: var(--sos-red);
    }
    
    .message-sender {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    
    .message.own .message-sender { color: rgba(255,255,255,0.7); }
    
    .message-time {
      font-size: 9px;
      color: var(--text-dim);
      text-align: right;
      margin-top: 4px;
    }
    
    .message.own .message-time { color: rgba(255,255,255,0.5); }
    
    .system-message {
      text-align: center;
      color: var(--text-dim);
      font-size: 11px;
      padding: 8px;
    }
    
    /* Chat input */
    .chat-input-area {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .chat-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 13px;
      outline: none;
    }
    
    .chat-input:focus {
      border-color: var(--sos-red);
    }
    
    .chat-input::placeholder { color: var(--text-dim); }
    
    .send-btn {
      padding: 10px 20px;
      background: var(--sos-red-dark);
      border: 1px solid var(--sos-red);
      color: white;
      font-family: var(--font-main);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .send-btn:hover { background: var(--sos-red); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* PIN overlay for rotating mode */
    .pin-overlay {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      border: 1px solid var(--sos-yellow);
      padding: 8px 16px;
      font-size: 11px;
      color: var(--sos-yellow);
      z-index: 100;
      display: none;
    }
    
    .pin-overlay.visible { display: block; }
    
    /* Back button */
    .back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      margin-right: 8px;
    }
    
    .back-btn:hover { color: var(--sos-red); }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--text-dim);
      border-top-color: var(--sos-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 400px) {
      .emoji-picker { grid-template-columns: repeat(6, 1fr); }
      .room-id-display { font-size: 24px; gap: 6px; }
      .emoji-btn { font-size: 18px; }
    }
    
    /* Hidden utility */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="app">
    <!-- ===== WELCOME SCREEN ===== -->
    <section id="welcome-screen" class="screen active">
      <header class="header">
        <pre class="header-logo">â–’â–’â–’â–’â–’â–’â–’â•— â–’â–’â–’â–’â–’â–’â•— â–’â–’â–’â–’â–’â–’â–’â•—
â–’â–’â•”â•â•â•â•â•â–’â–’â•”â•â•â•â–’â–’â•—â–’â–’â•”â•â•â•â•â•
â–’â–’â–’â–’â–’â–’â–’â•—â–’â–’â•‘   â–’â–’â•‘â–’â–’â–’â–’â–’â–’â–’â•—
â•šâ•â•â•â•â–’â–’â•‘â–’â–’â•‘   â–’â–’â•‘â•šâ•â•â•â•â–’â–’â•‘
â–’â–’â–’â–’â–’â–’â–’â•‘â•šâ–’â–’â–’â–’â–’â–’â•”â•â–’â–’â–’â–’â–’â–’â–’â•‘
â•šâ•â•â•â•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•â•â•â•â•â•</pre>
        <div class="header-subtitle">Emergency Secure Chat</div>
      </header>
      
      <div class="content">
        <div class="welcome-info">
          <div class="icon">ğŸ”</div>
          <h2>Private Rooms via DNS Tunnel</h2>
          <p>End-to-end encrypted chat that works even when the internet is blocked.</p>
          
          <ul class="feature-list">
            <li><span class="check">âœ“</span> 6-emoji room ID + 6-digit PIN</li>
            <li><span class="check">âœ“</span> Rooms auto-wipe after 1 hour</li>
            <li><span class="check">âœ“</span> Works during internet blackouts</li>
            <li><span class="check">âœ“</span> No registration, no traces</li>
          </ul>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showCreateRoom()">Create Room</button>
          <button class="btn" onclick="showJoinRoom()">Join Room</button>
        </div>
      </div>
    </section>
    
    <!-- ===== SETUP SCREEN (Create/Join) ===== -->
    <section id="setup-screen" class="screen">
      <header class="header" style="display: flex; align-items: center;">
        <button class="back-btn" onclick="showWelcome()">â†</button>
        <div style="flex:1;">
          <div class="header-subtitle" id="setup-title">Create Room</div>
        </div>
      </header>
      
      <div class="content">
        <!-- Room ID Section -->
        <div class="setup-section">
          <h3>Room ID (6 Emojis)</h3>
          
          <!-- Create mode: display generated emojis -->
          <div id="create-room-id" class="hidden">
            <div class="room-id-display" id="room-emojis-display"></div>
            <div class="room-id-phonetic" id="room-phonetic"></div>
          </div>
          
          <!-- Join mode: emoji picker -->
          <div id="join-room-id" class="hidden">
            <div class="emoji-picker" id="emoji-picker"></div>
            <div class="emoji-selected" id="selected-emojis">
              <span style="color: var(--text-dim); font-size: 12px;">Click emojis above (need 6)</span>
            </div>
          </div>
        </div>
        
        <!-- Mode Section (Create only) -->
        <div class="setup-section" id="mode-section">
          <h3>Key Mode</h3>
          <div class="mode-selector">
            <button class="mode-btn active" data-mode="rotating" onclick="selectMode('rotating')">
              <span class="icon">ğŸ”„</span>
              Rotating
              <small style="display:block; font-size:9px; color:var(--text-dim);">Changes every 15s</small>
            </button>
            <button class="mode-btn" data-mode="fixed" onclick="selectMode('fixed')">
              <span class="icon">ğŸ“Œ</span>
              Fixed
              <small style="display:block; font-size:9px; color:var(--text-dim);">Static PIN</small>
            </button>
          </div>
        </div>
        
        <!-- PIN Section -->
        <div class="setup-section">
          <h3 id="pin-section-title">PIN</h3>
          
          <!-- Create mode: display PIN -->
          <div id="create-pin" class="hidden">
            <div class="pin-display" id="pin-display"></div>
            <div class="pin-timer" id="pin-timer">Refreshes in 15s</div>
          </div>
          
          <!-- Join mode: PIN input -->
          <div id="join-pin" class="hidden">
            <div class="pin-input-group">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
            </div>
          </div>
        </div>
        
        <!-- Status -->
        <div id="setup-status" class="status hidden"></div>
      </div>
      
      <div class="setup-actions">
        <button class="btn" onclick="showWelcome()">Cancel</button>
        <button class="btn btn-primary" id="setup-action-btn" onclick="performSetupAction()">
          Create Room
        </button>
      </div>
    </section>
    
    <!-- ===== CHAT SCREEN ===== -->
    <section id="chat-screen" class="screen">
      <header class="chat-header">
        <div class="chat-room-info">
          <button class="back-btn" onclick="leaveRoom()">â†</button>
          <div>
            <div class="chat-room-emojis" id="chat-room-emojis"></div>
            <div class="chat-room-meta">
              <span class="expiry" id="chat-expiry"></span>
              <span id="chat-members"></span>
            </div>
          </div>
        </div>
        <div class="chat-status">
          <span class="status-dot" id="connection-dot"></span>
          <span id="connection-text">Connecting...</span>
        </div>
      </header>
      
      <div class="chat-messages" id="chat-messages"></div>
      
      <!-- PIN overlay for sharing with joiners -->
      <div class="pin-overlay" id="pin-overlay">
        Current PIN: <strong id="overlay-pin"></strong> (refreshes in <span id="overlay-timer"></span>s)
      </div>
      
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="message-input" placeholder="Type a message..." maxlength="2000">
        <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
      </div>
    </section>
  </div>
  
  <!-- TweetNaCl.js (inlined for offline use) -->
  <script>
    /*! TweetNaCl.js - Public Domain - https://tweetnacl.js.org/ - @dchest */
    !function(i){"use strict";var m=function(r,n){this.hi=0|r,this.lo=0|n},v=function(r){var n,e=new Float64Array(16);if(r)for(n=0;n<r.length;n++)e[n]=r[n];return e},a=function(){throw new Error("no PRNG")},o=new Uint8Array(16),e=new Uint8Array(32);e[0]=9;var c=v(),w=v([1]),g=v([56129,1]),y=v([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),l=v([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),t=v([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),f=v([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),s=v([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function h(r,n){return r<<n|r>>>32-n}function b(r,n){var e=255&r[n+3];return(e=(e=e<<8|255&r[n+2])<<8|255&r[n+1])<<8|255&r[n+0]}function B(r,n){var e=r[n]<<24|r[n+1]<<16|r[n+2]<<8|r[n+3],t=r[n+4]<<24|r[n+5]<<16|r[n+6]<<8|r[n+7];return new m(e,t)}function p(r,n,e){var t;for(t=0;t<4;t++)r[n+t]=255&e,e>>>=8}function S(r,n,e){r[n]=e.hi>>24&255,r[n+1]=e.hi>>16&255,r[n+2]=e.hi>>8&255,r[n+3]=255&e.hi,r[n+4]=e.lo>>24&255,r[n+5]=e.lo>>16&255,r[n+6]=e.lo>>8&255,r[n+7]=255&e.lo}function u(r,n,e,t,o){var i,a=0;for(i=0;i<o;i++)a|=r[n+i]^e[t+i];return(1&a-1>>>8)-1}function A(r,n,e,t){return u(r,n,e,t,16)}function _(r,n,e,t){return u(r,n,e,t,32)}function U(r,n,e,t,o){var i,a,f,u=new Uint32Array(16),c=new Uint32Array(16),w=new Uint32Array(16),y=new Uint32Array(4);for(i=0;i<4;i++)c[5*i]=b(t,4*i),c[1+i]=b(e,4*i),c[6+i]=b(n,4*i),c[11+i]=b(e,16+4*i);for(i=0;i<16;i++)w[i]=c[i];for(i=0;i<20;i++){for(a=0;a<4;a++){for(f=0;f<4;f++)y[f]=c[(5*a+4*f)%16];for(y[1]^=h(y[0]+y[3]|0,7),y[2]^=h(y[1]+y[0]|0,9),y[3]^=h(y[2]+y[1]|0,13),y[0]^=h(y[3]+y[2]|0,18),f=0;f<4;f++)u[4*a+(a+f)%4]=y[f]}for(f=0;f<16;f++)c[f]=u[f]}if(o){for(i=0;i<16;i++)c[i]=c[i]+w[i]|0;for(i=0;i<4;i++)c[5*i]=c[5*i]-b(t,4*i)|0,c[6+i]=c[6+i]-b(n,4*i)|0;for(i=0;i<4;i++)p(r,4*i,c[5*i]),p(r,16+4*i,c[6+i])}else for(i=0;i<16;i++)p(r,4*i,c[i]+w[i]|0)}function E(r,n,e,t){U(r,n,e,t,!1)}function x(r,n,e,t){return U(r,n,e,t,!0),0}var d=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function K(r,n,e,t,o,i,a){var f,u,c=new Uint8Array(16),w=new Uint8Array(64);if(!o)return 0;for(u=0;u<16;u++)c[u]=0;for(u=0;u<8;u++)c[u]=i[u];for(;64<=o;){for(E(w,c,a,d),u=0;u<64;u++)r[n+u]=(e?e[t+u]:0)^w[u];for(f=1,u=8;u<16;u++)f=f+(255&c[u])|0,c[u]=255&f,f>>>=8;o-=64,n+=64,e&&(t+=64)}if(0<o)for(E(w,c,a,d),u=0;u<o;u++)r[n+u]=(e?e[t+u]:0)^w[u];return 0}function Y(r,n,e,t,o){return K(r,n,null,0,e,t,o)}function L(r,n,e,t,o){var i=new Uint8Array(32);return x(i,t,o,d),Y(r,n,e,t.subarray(16),i)}function T(r,n,e,t,o,i,a){var f=new Uint8Array(32);return x(f,i,a,d),K(r,n,e,t,o,i.subarray(16),f)}function k(r,n){var e,t=0;for(e=0;e<17;e++)t=t+(r[e]+n[e]|0)|0,r[e]=255&t,t>>>=8}var z=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function R(r,n,e,t,o,i){var a,f,u,c,w=new Uint32Array(17),y=new Uint32Array(17),l=new Uint32Array(17),s=new Uint32Array(17),h=new Uint32Array(17);for(u=0;u<17;u++)y[u]=l[u]=0;for(u=0;u<16;u++)y[u]=i[u];for(y[3]&=15,y[4]&=252,y[7]&=15,y[8]&=252,y[11]&=15,y[12]&=252,y[15]&=15;0<o;){for(u=0;u<17;u++)s[u]=0;for(u=0;u<16&&u<o;++u)s[u]=e[t+u];for(s[u]=1,t+=u,o-=u,k(l,s),f=0;f<17;f++)for(u=w[f]=0;u<17;u++)w[f]=w[f]+l[u]*(u<=f?y[f-u]:320*y[f+17-u]|0)|0;for(f=0;f<17;f++)l[f]=w[f];for(u=c=0;u<16;u++)c=c+l[u]|0,l[u]=255&c,c>>>=8;for(c=c+l[16]|0,l[16]=3&c,c=5*(c>>>2)|0,u=0;u<16;u++)c=c+l[u]|0,l[u]=255&c,c>>>=8;c=c+l[16]|0,l[16]=c}for(u=0;u<17;u++)h[u]=l[u];for(k(l,z),a=0|-(l[16]>>>7),u=0;u<17;u++)l[u]^=a&(h[u]^l[u]);for(u=0;u<16;u++)s[u]=i[u+16];for(s[16]=0,k(l,s),u=0;u<16;u++)r[n+u]=l[u];return 0}function P(r,n,e,t,o,i){var a=new Uint8Array(16);return R(a,0,e,t,o,i),A(r,n,a,0)}function M(r,n,e,t,o){var i;if(e<32)return-1;for(T(r,0,n,0,e,t,o),R(r,16,r,32,e-32,r),i=0;i<16;i++)r[i]=0;return 0}function N(r,n,e,t,o){var i,a=new Uint8Array(32);if(e<32)return-1;if(L(a,0,32,t,o),0!==P(n,16,n,32,e-32,a))return-1;for(T(r,0,n,0,e,t,o),i=0;i<32;i++)r[i]=0;return 0}function O(r,n){var e;for(e=0;e<16;e++)r[e]=0|n[e]}function C(r){var n,e;for(e=0;e<16;e++)r[e]+=65536,n=Math.floor(r[e]/65536),r[(e+1)*(e<15?1:0)]+=n-1+37*(n-1)*(15===e?1:0),r[e]-=65536*n}function F(r,n,e){for(var t,o=~(e-1),i=0;i<16;i++)t=o&(r[i]^n[i]),r[i]^=t,n[i]^=t}function Z(r,n){var e,t,o,i=v(),a=v();for(e=0;e<16;e++)a[e]=n[e];for(C(a),C(a),C(a),t=0;t<2;t++){for(i[0]=a[0]-65517,e=1;e<15;e++)i[e]=a[e]-65535-(i[e-1]>>16&1),i[e-1]&=65535;i[15]=a[15]-32767-(i[14]>>16&1),o=i[15]>>16&1,i[14]&=65535,F(a,i,1-o)}for(e=0;e<16;e++)r[2*e]=255&a[e],r[2*e+1]=a[e]>>8}function G(r,n){var e=new Uint8Array(32),t=new Uint8Array(32);return Z(e,r),Z(t,n),_(e,0,t,0)}function q(r){var n=new Uint8Array(32);return Z(n,r),1&n[0]}function D(r,n){var e;for(e=0;e<16;e++)r[e]=n[2*e]+(n[2*e+1]<<8);r[15]&=32767}function I(r,n,e){var t;for(t=0;t<16;t++)r[t]=n[t]+e[t]|0}function V(r,n,e){var t;for(t=0;t<16;t++)r[t]=n[t]-e[t]|0}function X(r,n,e){var t,o,i=new Float64Array(31);for(t=0;t<31;t++)i[t]=0;for(t=0;t<16;t++)for(o=0;o<16;o++)i[t+o]+=n[t]*e[o];for(t=0;t<15;t++)i[t]+=38*i[t+16];for(t=0;t<16;t++)r[t]=i[t];C(r),C(r)}function j(r,n){X(r,n,n)}function H(r,n){var e,t=v();for(e=0;e<16;e++)t[e]=n[e];for(e=253;0<=e;e--)j(t,t),2!==e&&4!==e&&X(t,t,n);for(e=0;e<16;e++)r[e]=t[e]}function J(r,n){var e,t=v();for(e=0;e<16;e++)t[e]=n[e];for(e=250;0<=e;e--)j(t,t),1!==e&&X(t,t,n);for(e=0;e<16;e++)r[e]=t[e]}function Q(r,n,e){var t,o,i=new Uint8Array(32),a=new Float64Array(80),f=v(),u=v(),c=v(),w=v(),y=v(),l=v();for(o=0;o<31;o++)i[o]=n[o];for(i[31]=127&n[31]|64,i[0]&=248,D(a,e),o=0;o<16;o++)u[o]=a[o],w[o]=f[o]=c[o]=0;for(f[0]=w[0]=1,o=254;0<=o;--o)F(f,u,t=i[o>>>3]>>>(7&o)&1),F(c,w,t),I(y,f,c),V(f,f,c),I(c,u,w),V(u,u,w),j(w,y),j(l,f),X(f,c,f),X(c,u,y),I(y,f,c),V(f,f,c),j(u,f),V(c,w,l),X(f,c,g),I(f,f,w),X(c,c,f),X(f,w,l),X(w,u,a),j(u,y),F(f,u,t),F(c,w,t);for(o=0;o<16;o++)a[o+16]=f[o],a[o+32]=c[o],a[o+48]=u[o],a[o+64]=w[o];var s=a.subarray(32),h=a.subarray(16);return H(s,s),X(h,h,s),Z(r,h),0}function W(r,n){return Q(r,n,e)}function $(r,n){return a(n,32),W(r,n)}function rr(r,n,e){var t=new Uint8Array(32);return Q(t,e,n),x(r,o,t,d)}var nr=M,er=N;function tr(){var r,n,e,t=0,o=0,i=0,a=0,f=65535;for(e=0;e<arguments.length;e++)t+=(r=arguments[e].lo)&f,o+=r>>>16,i+=(n=arguments[e].hi)&f,a+=n>>>16;return new m((i+=(o+=t>>>16)>>>16)&f|(a+=i>>>16)<<16,t&f|o<<16)}function or(r,n){return new m(r.hi>>>n,r.lo>>>n|r.hi<<32-n)}function ir(){var r,n=0,e=0;for(r=0;r<arguments.length;r++)n^=arguments[r].lo,e^=arguments[r].hi;return new m(e,n)}function ar(r,n){var e,t,o=32-n;return n<32?(e=r.hi>>>n|r.lo<<o,t=r.lo>>>n|r.hi<<o):n<64&&(e=r.lo>>>n|r.hi<<o,t=r.hi>>>n|r.lo<<o),new m(e,t)}var fr=[new m(1116352408,3609767458),new m(1899447441,602891725),new m(3049323471,3964484399),new m(3921009573,2173295548),new m(961987163,4081628472),new m(1508970993,3053834265),new m(2453635748,2937671579),new m(2870763221,3664609560),new m(3624381080,2734883394),new m(310598401,1164996542),new m(607225278,1323610764),new m(1426881987,3590304994),new m(1925078388,4068182383),new m(2162078206,991336113),new m(2614888103,633803317),new m(3248222580,3479774868),new m(3835390401,2666613458),new m(4022224774,944711139),new m(264347078,2341262773),new m(604807628,2007800933),new m(770255983,1495990901),new m(1249150122,1856431235),new m(1555081692,3175218132),new m(1996064986,2198950837),new m(2554220882,3999719339),new m(2821834349,766784016),new m(2952996808,2566594879),new m(3210313671,3203337956),new m(3336571891,1034457026),new m(3584528711,2466948901),new m(113926993,3758326383),new m(338241895,168717936),new m(666307205,1188179964),new m(773529912,1546045734),new m(1294757372,1522805485),new m(1396182291,2643833823),new m(1695183700,2343527390),new m(1986661051,1014477480),new m(2177026350,1206759142),new m(2456956037,344077627),new m(2730485921,1290863460),new m(2820302411,3158454273),new m(3259730800,3505952657),new m(3345764771,106217008),new m(3516065817,3606008344),new m(3600352804,1432725776),new m(4094571909,1467031594),new m(275423344,851169720),new m(430227734,3100823752),new m(506948616,1363258195),new m(659060556,3750685593),new m(883997877,3785050280),new m(958139571,3318307427),new m(1322822218,3812723403),new m(1537002063,2003034995),new m(1747873779,3602036899),new m(1955562222,1575990012),new m(2024104815,1125592928),new m(2227730452,2716904306),new m(2361852424,442776044),new m(2428436474,593698344),new m(2756734187,3733110249),new m(3204031479,2999351573),new m(3329325298,3815920427),new m(3391569614,3928383900),new m(3515267271,566280711),new m(3940187606,3454069534),new m(4118630271,4000239992),new m(116418474,1914138554),new m(174292421,2731055270),new m(289380356,3203993006),new m(460393269,320620315),new m(685471733,587496836),new m(852142971,1086792851),new m(1017036298,365543100),new m(1126000580,2618297676),new m(1288033470,3409855158),new m(1501505948,4234509866),new m(1607167915,987167468),new m(1816402316,1246189591)];function ur(r,n,e){var t,o,i,a=[],f=[],u=[],c=[];for(o=0;o<8;o++)a[o]=u[o]=B(r,8*o);for(var w,y,l,s,h,v,g,b,p,A,_,U,E,x,d=0;128<=e;){for(o=0;o<16;o++)c[o]=B(n,8*o+d);for(o=0;o<80;o++){for(i=0;i<8;i++)f[i]=u[i];for(t=tr(u[7],ir(ar(x=u[4],14),ar(x,18),ar(x,41)),(p=u[4],A=u[5],_=u[6],0,U=p.hi&A.hi^~p.hi&_.hi,E=p.lo&A.lo^~p.lo&_.lo,new m(U,E)),fr[o],c[o%16]),f[7]=tr(t,ir(ar(b=u[0],28),ar(b,34),ar(b,39)),(l=u[0],s=u[1],h=u[2],0,v=l.hi&s.hi^l.hi&h.hi^s.hi&h.hi,g=l.lo&s.lo^l.lo&h.lo^s.lo&h.lo,new m(v,g))),f[3]=tr(f[3],t),i=0;i<8;i++)u[(i+1)%8]=f[i];if(o%16==15)for(i=0;i<16;i++)c[i]=tr(c[i],c[(i+9)%16],ir(ar(y=c[(i+1)%16],1),ar(y,8),or(y,7)),ir(ar(w=c[(i+14)%16],19),ar(w,61),or(w,6)))}for(o=0;o<8;o++)u[o]=tr(u[o],a[o]),a[o]=u[o];d+=128,e-=128}for(o=0;o<8;o++)S(r,8*o,a[o]);return e}var cr=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function wr(r,n,e){var t,o=new Uint8Array(64),i=new Uint8Array(256),a=e;for(t=0;t<64;t++)o[t]=cr[t];for(ur(o,n,e),e%=128,t=0;t<256;t++)i[t]=0;for(t=0;t<e;t++)i[t]=n[a-e+t];for(i[e]=128,i[(e=256-128*(e<112?1:0))-9]=0,S(i,e-8,new m(a/536870912|0,a<<3)),ur(o,i,e),t=0;t<64;t++)r[t]=o[t];return 0}function yr(r,n){var e=v(),t=v(),o=v(),i=v(),a=v(),f=v(),u=v(),c=v(),w=v();V(e,r[1],r[0]),V(w,n[1],n[0]),X(e,e,w),I(t,r[0],r[1]),I(w,n[0],n[1]),X(t,t,w),X(o,r[3],n[3]),X(o,o,l),X(i,r[2],n[2]),I(i,i,i),V(a,t,e),V(f,i,o),I(u,i,o),I(c,t,e),X(r[0],a,f),X(r[1],c,u),X(r[2],u,f),X(r[3],a,c)}function lr(r,n,e){var t;for(t=0;t<4;t++)F(r[t],n[t],e)}function sr(r,n){var e=v(),t=v(),o=v();H(o,n[2]),X(e,n[0],o),X(t,n[1],o),Z(r,t),r[31]^=q(e)<<7}function hr(r,n,e){var t,o;for(O(r[0],c),O(r[1],w),O(r[2],w),O(r[3],c),o=255;0<=o;--o)lr(r,n,t=e[o/8|0]>>(7&o)&1),yr(n,r),yr(r,r),lr(r,n,t)}function vr(r,n){var e=[v(),v(),v(),v()];O(e[0],t),O(e[1],f),O(e[2],w),X(e[3],t,f),hr(r,e,n)}function gr(r,n,e){var t,o=new Uint8Array(64),i=[v(),v(),v(),v()];for(e||a(n,32),wr(o,n,32),o[0]&=248,o[31]&=127,o[31]|=64,vr(i,o),sr(r,i),t=0;t<32;t++)n[t+32]=r[t];return 0}var br=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function pr(r,n){var e,t,o,i;for(t=63;32<=t;--t){for(e=0,o=t-32,i=t-12;o<i;++o)n[o]+=e-16*n[t]*br[o-(t-32)],e=Math.floor((n[o]+128)/256),n[o]-=256*e;n[o]+=e,n[t]=0}for(o=e=0;o<32;o++)n[o]+=e-(n[31]>>4)*br[o],e=n[o]>>8,n[o]&=255;for(o=0;o<32;o++)n[o]-=e*br[o];for(t=0;t<32;t++)n[t+1]+=n[t]>>8,r[t]=255&n[t]}function Ar(r){var n,e=new Float64Array(64);for(n=0;n<64;n++)e[n]=r[n];for(n=0;n<64;n++)r[n]=0;pr(r,e)}function _r(r,n,e,t){var o,i,a=new Uint8Array(64),f=new Uint8Array(64),u=new Uint8Array(64),c=new Float64Array(64),w=[v(),v(),v(),v()];wr(a,t,32),a[0]&=248,a[31]&=127,a[31]|=64;var y=e+64;for(o=0;o<e;o++)r[64+o]=n[o];for(o=0;o<32;o++)r[32+o]=a[32+o];for(wr(u,r.subarray(32),e+32),Ar(u),vr(w,u),sr(r,w),o=32;o<64;o++)r[o]=t[o];for(wr(f,r,e+64),Ar(f),o=0;o<64;o++)c[o]=0;for(o=0;o<32;o++)c[o]=u[o];for(o=0;o<32;o++)for(i=0;i<32;i++)c[o+i]+=f[o]*a[i];return pr(r.subarray(32),c),y}function Ur(r,n,e,t){var o,i=new Uint8Array(32),a=new Uint8Array(64),f=[v(),v(),v(),v()],u=[v(),v(),v(),v()];if(e<64)return-1;if(function(r,n){var e=v(),t=v(),o=v(),i=v(),a=v(),f=v(),u=v();if(O(r[2],w),D(r[1],n),j(o,r[1]),X(i,o,y),V(o,o,r[2]),I(i,r[2],i),j(a,i),j(f,a),X(u,f,a),X(e,u,o),X(e,e,i),J(e,e),X(e,e,o),X(e,e,i),X(e,e,i),X(r[0],e,i),j(t,r[0]),X(t,t,i),G(t,o)&&X(r[0],r[0],s),j(t,r[0]),X(t,t,i),G(t,o))return 1;q(r[0])===n[31]>>7&&V(r[0],c,r[0]),X(r[3],r[0],r[1])}(u,t))return-1;for(o=0;o<e;o++)r[o]=n[o];for(o=0;o<32;o++)r[o+32]=t[o];if(wr(a,r,e),Ar(a),hr(f,u,a),vr(u,n.subarray(32)),yr(f,u),sr(i,f),e-=64,_(n,0,i,0)){for(o=0;o<e;o++)r[o]=0;return-1}for(o=0;o<e;o++)r[o]=n[o+64];return e}function Er(r,n){if(32!==r.length)throw new Error("bad key size");if(24!==n.length)throw new Error("bad nonce size")}function xr(){for(var r=0;r<arguments.length;r++)if(!(arguments[r]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function dr(r){for(var n=0;n<r.length;n++)r[n]=0}i.lowlevel={crypto_core_hsalsa20:x,crypto_stream_xor:T,crypto_stream:L,crypto_stream_salsa20_xor:K,crypto_stream_salsa20:Y,crypto_onetimeauth:R,crypto_onetimeauth_verify:P,crypto_verify_16:A,crypto_verify_32:_,crypto_secretbox:M,crypto_secretbox_open:N,crypto_scalarmult:Q,crypto_scalarmult_base:W,crypto_box_beforenm:rr,crypto_box_afternm:nr,crypto_box:function(r,n,e,t,o,i){var a=new Uint8Array(32);return rr(a,o,i),nr(r,n,e,t,a)},crypto_box_open:function(r,n,e,t,o,i){var a=new Uint8Array(32);return rr(a,o,i),er(r,n,e,t,a)},crypto_box_keypair:$,crypto_hash:wr,crypto_sign:_r,crypto_sign_keypair:gr,crypto_sign_open:Ur,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:v,D:y,L:br,pack25519:Z,unpack25519:D,M:X,A:I,S:j,Z:V,pow2523:J,add:yr,set25519:O,modL:pr,scalarmult:hr,scalarbase:vr},i.randomBytes=function(r){var n=new Uint8Array(r);return a(n,r),n},i.secretbox=function(r,n,e){xr(r,n,e),Er(e,n);for(var t=new Uint8Array(32+r.length),o=new Uint8Array(t.length),i=0;i<r.length;i++)t[i+32]=r[i];return M(o,t,t.length,n,e),o.subarray(16)},i.secretbox.open=function(r,n,e){xr(r,n,e),Er(e,n);for(var t=new Uint8Array(16+r.length),o=new Uint8Array(t.length),i=0;i<r.length;i++)t[i+16]=r[i];return t.length<32||0!==N(o,t,t.length,n,e)?null:o.subarray(32)},i.secretbox.keyLength=32,i.secretbox.nonceLength=24,i.secretbox.overheadLength=16,i.scalarMult=function(r,n){if(xr(r,n),32!==r.length)throw new Error("bad n size");if(32!==n.length)throw new Error("bad p size");var e=new Uint8Array(32);return Q(e,r,n),e},i.scalarMult.base=function(r){if(xr(r),32!==r.length)throw new Error("bad n size");var n=new Uint8Array(32);return W(n,r),n},i.scalarMult.scalarLength=32,i.scalarMult.groupElementLength=32,i.box=function(r,n,e,t){var o=i.box.before(e,t);return i.secretbox(r,n,o)},i.box.before=function(r,n){xr(r,n),function(r,n){if(32!==r.length)throw new Error("bad public key size");if(32!==n.length)throw new Error("bad secret key size")}(r,n);var e=new Uint8Array(32);return rr(e,r,n),e},i.box.after=i.secretbox,i.box.open=function(r,n,e,t){var o=i.box.before(e,t);return i.secretbox.open(r,n,o)},i.box.open.after=i.secretbox.open,i.box.keyPair=function(){var r=new Uint8Array(32),n=new Uint8Array(32);return $(r,n),{publicKey:r,secretKey:n}},i.box.keyPair.fromSecretKey=function(r){if(xr(r),32!==r.length)throw new Error("bad secret key size");var n=new Uint8Array(32);return W(n,r),{publicKey:n,secretKey:new Uint8Array(r)}},i.box.publicKeyLength=32,i.box.secretKeyLength=32,i.box.sharedKeyLength=32,i.box.nonceLength=24,i.box.overheadLength=i.secretbox.overheadLength,i.sign=function(r,n){if(xr(r,n),64!==n.length)throw new Error("bad secret key size");var e=new Uint8Array(64+r.length);return _r(e,r,r.length,n),e},i.sign.open=function(r,n){if(xr(r,n),32!==n.length)throw new Error("bad public key size");var e=new Uint8Array(r.length),t=Ur(e,r,r.length,n);if(t<0)return null;for(var o=new Uint8Array(t),i=0;i<o.length;i++)o[i]=e[i];return o},i.sign.detached=function(r,n){for(var e=i.sign(r,n),t=new Uint8Array(64),o=0;o<t.length;o++)t[o]=e[o];return t},i.sign.detached.verify=function(r,n,e){if(xr(r,n,e),64!==n.length)throw new Error("bad signature size");if(32!==e.length)throw new Error("bad public key size");var t,o=new Uint8Array(64+r.length),i=new Uint8Array(64+r.length);for(t=0;t<64;t++)o[t]=n[t];for(t=0;t<r.length;t++)o[t+64]=r[t];return 0<=Ur(i,o,o.length,e)},i.sign.keyPair=function(){var r=new Uint8Array(32),n=new Uint8Array(64);return gr(r,n),{publicKey:r,secretKey:n}},i.sign.keyPair.fromSecretKey=function(r){if(xr(r),64!==r.length)throw new Error("bad secret key size");for(var n=new Uint8Array(32),e=0;e<n.length;e++)n[e]=r[32+e];return{publicKey:n,secretKey:new Uint8Array(r)}},i.sign.keyPair.fromSeed=function(r){if(xr(r),32!==r.length)throw new Error("bad seed size");for(var n=new Uint8Array(32),e=new Uint8Array(64),t=0;t<32;t++)e[t]=r[t];return gr(n,e,!0),{publicKey:n,secretKey:e}},i.sign.publicKeyLength=32,i.sign.secretKeyLength=64,i.sign.seedLength=32,i.sign.signatureLength=64,i.hash=function(r){xr(r);var n=new Uint8Array(64);return wr(n,r,r.length),n},i.hash.hashLength=64,i.verify=function(r,n){return xr(r,n),0!==r.length&&0!==n.length&&(r.length===n.length&&0===u(r,0,n,0,r.length))},i.setPRNG=function(r){a=r},function(){var o="undefined"!=typeof self?self.crypto||self.msCrypto:null;if(o&&o.getRandomValues){i.setPRNG(function(r,n){var e,t=new Uint8Array(n);for(e=0;e<n;e+=65536)o.getRandomValues(t.subarray(e,e+Math.min(n-e,65536)));for(e=0;e<n;e++)r[e]=t[e];dr(t)})}else"undefined"!=typeof require&&(o=require("crypto"))&&o.randomBytes&&i.setPRNG(function(r,n){var e,t=o.randomBytes(n);for(e=0;e<n;e++)r[e]=t[e];dr(t)})}()}("undefined"!=typeof module&&module.exports?module.exports:self.nacl=self.nacl||{});
  </script>
  
  <!-- Argon2 WASM (minimal inline loader) -->
  <script>
  // Argon2 browser implementation using SubtleCrypto PBKDF2 fallback
  // For full Argon2id support, load argon2-browser WASM module
  // This provides a compatible interface that falls back gracefully
  
  window.argon2 = {
    // Configuration matching Python implementation
    ArgonType: { Argon2id: 2 },
    
    // Hash function - uses PBKDF2 as fallback (less secure but works everywhere)
    // In production, load full argon2-browser WASM for true Argon2id
    hash: async function(options) {
      const { pass, salt, time, mem, parallelism, hashLen, type } = options;
      
      // Convert inputs to proper format
      const passBytes = typeof pass === 'string' ? new TextEncoder().encode(pass) : pass;
      const saltBytes = typeof salt === 'string' ? new TextEncoder().encode(salt) : salt;
      
      // Try to use real Argon2 if available
      if (window._argon2_wasm) {
        return window._argon2_wasm.hash(options);
      }
      
      // Fallback: Use PBKDF2 with high iterations (less secure than Argon2id)
      // Note: This makes web clients interoperable but with reduced KDF strength
      // For true Argon2id, include argon2-browser WASM module
      try {
        const keyMaterial = await crypto.subtle.importKey(
          'raw', passBytes, 'PBKDF2', false, ['deriveBits']
        );
        
        // Use PBKDF2 with iterations approximating Argon2 cost
        // time_cost=2, mem_cost=65536 roughly equals 100000 PBKDF2 iterations
        const iterations = time * 50000;
        
        const derivedBits = await crypto.subtle.deriveBits(
          {
            name: 'PBKDF2',
            salt: saltBytes,
            iterations: iterations,
            hash: 'SHA-256'
          },
          keyMaterial,
          hashLen * 8
        );
        
        return {
          hash: new Uint8Array(derivedBits),
          hashHex: Array.from(new Uint8Array(derivedBits))
            .map(b => b.toString(16).padStart(2, '0')).join('')
        };
      } catch (e) {
        console.error('Key derivation failed:', e);
        throw e;
      }
    }
  };
  </script>
  
  <!-- App Logic -->
  <script>
    /**
     * SOS Emergency Chat - Web Client
     * 
     * End-to-end encrypted chat rooms over DNS tunnel.
     * Compatible with TUI client (same crypto spec).
     * 
     * Crypto Spec (must match crypto.py exactly):
     * - Room ID: 6 emojis from 32-emoji set
     * - Room hash: SHA256(emojis)[:16] hex
     * - Salt: SHA256("sos-chat-v1:" + emojis + [":" + timestamp])[:16]
     * - Password: emojis + ":" + pin (UTF-8)
     * - KDF: Argon2id (time=2, mem=64MB, p=1, hashLen=32)
     * - Encryption: NaCl SecretBox (XSalsa20-Poly1305)
     * - Nonce: 24 bytes, prepended to ciphertext
     */

    // ============================================================================
    // CONFIGURATION
    // ============================================================================

    const CONFIG = {
    // Relay server (relative URL when served from relay, absolute for testing)
    RELAY_URL: '',  // Empty = same origin
    
    // Polling interval (ms)
    POLL_INTERVAL: 1500,
    
    // PIN rotation window (seconds)
    PIN_WINDOW: 15,
    
    // Room TTL (seconds)
    ROOM_TTL: 3600,
    
    // Max message length
    MAX_MESSAGE_LENGTH: 2000
    };

    // ============================================================================
    // EMOJI SET (must match crypto.py exactly, same order)
    // ============================================================================

    const EMOJI_SET = [
    "ğŸ”¥", "ğŸŒ™", "â­", "ğŸ¯", "ğŸŒŠ", "ğŸ’", "ğŸ€", "ğŸ²",
    "ğŸš€", "ğŸŒˆ", "âš¡", "ğŸµ", "ğŸ”‘", "ğŸŒ¸", "ğŸ„", "ğŸ¦‹",
    "ğŸª", "ğŸŒµ", "ğŸ", "ğŸ‹", "ğŸ¦Š", "ğŸŒ»", "ğŸ­", "ğŸ””",
    "ğŸ”ï¸", "ğŸŒ´", "ğŸ•", "ğŸ™", "ğŸ¦‰", "ğŸŒº", "ğŸ¨", "ğŸ”®"
    ];

    const EMOJI_PHONETICS = {
    "ğŸ”¥": "fire", "ğŸŒ™": "moon", "â­": "star", "ğŸ¯": "target",
    "ğŸŒŠ": "wave", "ğŸ’": "gem", "ğŸ€": "clover", "ğŸ²": "dice",
    "ğŸš€": "rocket", "ğŸŒˆ": "rainbow", "âš¡": "bolt", "ğŸµ": "music",
    "ğŸ”‘": "key", "ğŸŒ¸": "bloom", "ğŸ„": "shroom", "ğŸ¦‹": "butterfly",
    "ğŸª": "circus", "ğŸŒµ": "cactus", "ğŸ": "apple", "ğŸ‹": "whale",
    "ğŸ¦Š": "fox", "ğŸŒ»": "sunflower", "ğŸ­": "mask", "ğŸ””": "bell",
    "ğŸ”ï¸": "mountain", "ğŸŒ´": "palm", "ğŸ•": "pizza", "ğŸ™": "octopus",
    "ğŸ¦‰": "owl", "ğŸŒº": "hibiscus", "ğŸ¨": "palette", "ğŸ”®": "crystal"
    };

    // ============================================================================
    // STATE
    // ============================================================================

    let state = {
    mode: 'welcome',  // 'welcome', 'create', 'join', 'chat'
    
    // Room setup
    selectedEmojis: [],
    keyMode: 'rotating',  // 'rotating' or 'fixed'
    
    // Room session
    roomHash: null,
    roomEmojis: null,
    memberId: null,
    nickname: 'anon',
    createdAt: null,
    expiresAt: null,
    encryptionKey: null,
    fixedPin: null,
    
    // Chat state
    messages: [],
    lastMessageTs: 0,
    pollInterval: null,
    isConnected: false,
    
    // PIN timer
    pinTimerInterval: null,
    currentPin: null
    };

    // ============================================================================
    // CRYPTO FUNCTIONS (matching crypto.py exactly)
    // ============================================================================

    /**
     * Generate random emojis for room ID
     */
    function generateRoomId() {
    const emojis = [];
    for (let i = 0; i < 6; i++) {
        const idx = Math.floor(Math.random() * EMOJI_SET.length);
        emojis.push(EMOJI_SET[idx]);
    }
    return emojis;
    }

    /**
     * Generate 6-digit PIN
     */
    function generatePin() {
    let pin = '';
    for (let i = 0; i < 6; i++) {
        pin += Math.floor(Math.random() * 10).toString();
    }
    return pin;
    }

    /**
     * Compute SHA256 hash
     */
    async function sha256(data) {
    const encoder = new TextEncoder();
    const dataBytes = typeof data === 'string' ? encoder.encode(data) : data;
    const hashBuffer = await crypto.subtle.digest('SHA-256', dataBytes);
    return new Uint8Array(hashBuffer);
    }

    /**
     * Convert bytes to hex string
     */
    function bytesToHex(bytes) {
    return Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    /**
     * Convert hex string to bytes
     */
    function hexToBytes(hex) {
    const bytes = new Uint8Array(hex.length / 2);
    for (let i = 0; i < hex.length; i += 2) {
        bytes[i / 2] = parseInt(hex.substr(i, 2), 16);
    }
    return bytes;
    }

    /**
     * Calculate room hash from emojis
     * Hash = SHA256(emojis)[:16] as hex
     */
    async function roomIdToHash(emojis) {
    const emojiStr = emojis.join('');
    const hash = await sha256(emojiStr);
    return bytesToHex(hash).slice(0, 16);
    }

    /**
     * Get current PIN for rotating mode
     * PIN = SHA256(roomId + ":" + bucket)[:6] -> each hex char mod 10
     */
    async function getCurrentPin(emojis) {
    const roomId = emojis.join('');
    const bucket = Math.floor(Date.now() / 1000 / CONFIG.PIN_WINDOW);
    const seed = `${roomId}:${bucket}`;
    const hash = await sha256(seed);
    const hashHex = bytesToHex(hash);
    
    let pin = '';
    for (let i = 0; i < 6; i++) {
        pin += (parseInt(hashHex[i], 16) % 10).toString();
    }
    return pin;
    }

    /**
     * Get time remaining until next PIN rotation
     */
    function getTimeRemaining() {
    return CONFIG.PIN_WINDOW - (Math.floor(Date.now() / 1000) % CONFIG.PIN_WINDOW);
    }

    /**
     * Derive encryption key using Argon2id (or PBKDF2 fallback)
     * 
     * Salt = SHA256("sos-chat-v1:" + emojis + [":" + timestamp])[:16]
     * Password = emojis + ":" + pin
     */
    async function deriveRoomKey(emojis, pin, timestamp = null) {
    const emojiStr = emojis.join('');
    
    // Build salt input (must match Python exactly)
    let saltInput = `sos-chat-v1:${emojiStr}`;
    if (timestamp !== null) {
        saltInput += `:${Math.floor(timestamp)}`;
    }
    
    // Salt = SHA256(saltInput)[:16]
    const saltHash = await sha256(saltInput);
    const salt = saltHash.slice(0, 16);
    
    // Password = emojis:pin
    const password = `${emojiStr}:${pin}`;
    
    // Derive key using Argon2id (or fallback)
    const result = await argon2.hash({
        pass: password,
        salt: salt,
        time: 2,
        mem: 65536,  // 64 MB
        parallelism: 1,
        hashLen: 32,
        type: argon2.ArgonType.Argon2id
    });
    
    return result.hash;
    }

    /**
     * Get encryption key based on mode
     */
    async function getEncryptionKey(emojis, pin, mode, createdAt) {
    if (mode === 'fixed') {
        // Fixed mode: use room creation timestamp
        return await deriveRoomKey(emojis, pin, createdAt);
    } else {
        // Rotating mode: use current time bucket
        const bucket = Math.floor(Date.now() / 1000 / CONFIG.PIN_WINDOW) * CONFIG.PIN_WINDOW;
        return await deriveRoomKey(emojis, pin, bucket);
    }
    }

    /**
     * Encrypt message using NaCl SecretBox
     * Output: nonce (24 bytes) + ciphertext
     */
    function encryptMessage(message, key) {
    const messageBytes = new TextEncoder().encode(message);
    const nonce = nacl.randomBytes(nacl.secretbox.nonceLength);  // 24 bytes
    const ciphertext = nacl.secretbox(messageBytes, nonce, key);
    
    // Prepend nonce to ciphertext
    const result = new Uint8Array(nonce.length + ciphertext.length);
    result.set(nonce);
    result.set(ciphertext, nonce.length);
    
    return result;
    }

    /**
     * Decrypt message using NaCl SecretBox
     */
    function decryptMessage(encrypted, key) {
    try {
        const nonce = encrypted.slice(0, nacl.secretbox.nonceLength);
        const ciphertext = encrypted.slice(nacl.secretbox.nonceLength);
        const decrypted = nacl.secretbox.open(ciphertext, nonce, key);
        
        if (!decrypted) return null;
        return new TextDecoder().decode(decrypted);
    } catch (e) {
        console.error('Decryption failed:', e);
        return null;
    }
    }

    /**
     * Try decrypting with multiple keys (for rotating mode, try current and previous buckets)
     */
    async function tryDecrypt(encrypted, emojis, mode, createdAt) {
    const keys = [];
    
    if (mode === 'fixed') {
        // Fixed mode: only one key
        const pin = state.fixedPin;
        if (pin) {
        keys.push(await deriveRoomKey(emojis, pin, createdAt));
        }
    } else {
        // Rotating mode: try current and previous buckets
        const now = Date.now() / 1000;
        for (let offset = 0; offset <= 2; offset++) {
        const bucket = Math.floor((now - offset * CONFIG.PIN_WINDOW) / CONFIG.PIN_WINDOW) * CONFIG.PIN_WINDOW;
        const pin = await getCurrentPinForBucket(emojis, bucket);
        keys.push(await deriveRoomKey(emojis, pin, bucket));
        }
    }
    
    for (const key of keys) {
        const decrypted = decryptMessage(encrypted, key);
        if (decrypted !== null) {
        return decrypted;
        }
    }
    
    return null;
    }

    /**
     * Get PIN for a specific time bucket
     */
    async function getCurrentPinForBucket(emojis, bucket) {
    const roomId = emojis.join('');
    const bucketNum = Math.floor(bucket / CONFIG.PIN_WINDOW);
    const seed = `${roomId}:${bucketNum}`;
    const hash = await sha256(seed);
    const hashHex = bytesToHex(hash);
    
    let pin = '';
    for (let i = 0; i < 6; i++) {
        pin += (parseInt(hashHex[i], 16) % 10).toString();
    }
    return pin;
    }

    // ============================================================================
    // API FUNCTIONS
    // ============================================================================

    async function apiRequest(endpoint, method = 'GET', body = null) {
    const url = CONFIG.RELAY_URL + endpoint;
    const options = {
        method,
        headers: { 'Content-Type': 'application/json' }
    };
    
    if (body) {
        options.body = JSON.stringify(body);
    }
    
    try {
        const response = await fetch(url, options);
        const data = await response.json();
        
        if (!response.ok) {
        throw new Error(data.error || `HTTP ${response.status}`);
        }
        
        return data;
    } catch (e) {
        console.error(`API error (${endpoint}):`, e);
        throw e;
    }
    }

    async function createRoom(roomHash, mode) {
    return await apiRequest('/room', 'POST', { room_hash: roomHash, mode });
    }

    async function joinRoom(roomHash, nickname) {
    return await apiRequest(`/room/${roomHash}/join`, 'POST', { nickname });
    }

    async function sendMessageApi(roomHash, content, sender, memberId) {
    return await apiRequest(`/room/${roomHash}/send`, 'POST', {
        content,
        sender,
        member_id: memberId
    });
    }

    async function pollMessages(roomHash, since, memberId) {
    const params = new URLSearchParams({ since: since.toString() });
    if (memberId) params.append('member_id', memberId);
    return await apiRequest(`/room/${roomHash}/poll?${params}`);
    }

    async function leaveRoomApi(roomHash, memberId) {
    return await apiRequest(`/room/${roomHash}/leave`, 'POST', { member_id: memberId });
    }

    async function getRoomInfo(roomHash) {
    return await apiRequest(`/room/${roomHash}/info`);
    }

    // ============================================================================
    // UI FUNCTIONS
    // ============================================================================

    function showScreen(screenId) {
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById(screenId).classList.add('active');
    }

    function showWelcome() {
    state.mode = 'welcome';
    state.selectedEmojis = [];
    clearInterval(state.pinTimerInterval);
    clearInterval(state.pollInterval);
    showScreen('welcome-screen');
    }

    function showCreateRoom() {
    state.mode = 'create';
    state.selectedEmojis = generateRoomId();
    state.keyMode = 'rotating';
    state.fixedPin = generatePin();
    
    // Update UI
    document.getElementById('setup-title').textContent = 'Create Room';
    document.getElementById('setup-action-btn').textContent = 'Create Room';
    
    // Show create UI, hide join UI
    document.getElementById('create-room-id').classList.remove('hidden');
    document.getElementById('join-room-id').classList.add('hidden');
    document.getElementById('create-pin').classList.remove('hidden');
    document.getElementById('join-pin').classList.add('hidden');
    document.getElementById('mode-section').classList.remove('hidden');
    document.getElementById('pin-section-title').textContent = 'Current PIN (share with joiner)';
    
    // Display emojis
    updateEmojiDisplay();
    
    // Start PIN timer
    updatePinDisplay();
    startPinTimer();
    
    // Clear status
    hideStatus();
    
    showScreen('setup-screen');
    }

    function showJoinRoom() {
    state.mode = 'join';
    state.selectedEmojis = [];
    state.keyMode = 'rotating';  // Will be determined from room
    
    // Update UI
    document.getElementById('setup-title').textContent = 'Join Room';
    document.getElementById('setup-action-btn').textContent = 'Join Room';
    
    // Show join UI, hide create UI
    document.getElementById('create-room-id').classList.add('hidden');
    document.getElementById('join-room-id').classList.remove('hidden');
    document.getElementById('create-pin').classList.add('hidden');
    document.getElementById('join-pin').classList.remove('hidden');
    document.getElementById('mode-section').classList.add('hidden');
    document.getElementById('pin-section-title').textContent = 'Enter PIN';
    
    // Build emoji picker
    buildEmojiPicker();
    
    // Update selected emojis display
    updateSelectedEmojisDisplay();
    
    // Setup PIN inputs
    setupPinInputs();
    
    // Clear status
    hideStatus();
    
    showScreen('setup-screen');
    }

    function buildEmojiPicker() {
    const picker = document.getElementById('emoji-picker');
    picker.innerHTML = '';
    
    EMOJI_SET.forEach(emoji => {
        const btn = document.createElement('button');
        btn.className = 'emoji-btn';
        btn.textContent = emoji;
        btn.title = EMOJI_PHONETICS[emoji];
        btn.onclick = () => selectEmoji(emoji);
        picker.appendChild(btn);
    });
    }

    function selectEmoji(emoji) {
    if (state.selectedEmojis.length < 6) {
        state.selectedEmojis.push(emoji);
        updateSelectedEmojisDisplay();
    }
    }

    function removeLastEmoji() {
    if (state.selectedEmojis.length > 0) {
        state.selectedEmojis.pop();
        updateSelectedEmojisDisplay();
    }
    }

    function updateSelectedEmojisDisplay() {
    const container = document.getElementById('selected-emojis');
    
    if (state.selectedEmojis.length === 0) {
        container.innerHTML = '<span style="color: var(--text-dim); font-size: 12px;">Click emojis above (need 6)</span>';
        return;
    }
    
    container.innerHTML = state.selectedEmojis.map((e, i) => 
        `<span onclick="removeEmojiAt(${i})" title="Click to remove">${e}</span>`
    ).join('');
    
    if (state.selectedEmojis.length < 6) {
        container.innerHTML += `<span style="color: var(--text-dim);">(${6 - state.selectedEmojis.length} more)</span>`;
    }
    }

    function removeEmojiAt(index) {
    state.selectedEmojis.splice(index, 1);
    updateSelectedEmojisDisplay();
    }

    function updateEmojiDisplay() {
    const display = document.getElementById('room-emojis-display');
    const phonetic = document.getElementById('room-phonetic');
    
    display.innerHTML = state.selectedEmojis.map(e => `<span>${e}</span>`).join('');
    phonetic.textContent = state.selectedEmojis.map(e => EMOJI_PHONETICS[e]).join(' Â· ');
    }

    function selectMode(mode) {
    state.keyMode = mode;
    
    // Update UI
    document.querySelectorAll('.mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.mode === mode);
    });
    
    // Update PIN display
    updatePinDisplay();
    }

    async function updatePinDisplay() {
    const display = document.getElementById('pin-display');
    const timer = document.getElementById('pin-timer');
    
    let pin;
    if (state.keyMode === 'rotating') {
        pin = await getCurrentPin(state.selectedEmojis);
        timer.textContent = `Refreshes in ${getTimeRemaining()}s`;
        timer.classList.remove('fixed');
    } else {
        pin = state.fixedPin;
        timer.textContent = 'Fixed PIN (does not change)';
        timer.classList.add('fixed');
    }
    
    state.currentPin = pin;
    display.innerHTML = pin.split('').map(d => 
        `<div class="pin-digit filled">${d}</div>`
    ).join('');
    }

    function startPinTimer() {
    clearInterval(state.pinTimerInterval);
    
    state.pinTimerInterval = setInterval(async () => {
        if (state.keyMode === 'rotating') {
        await updatePinDisplay();
        }
    }, 1000);
    }

    function setupPinInputs() {
    const inputs = document.querySelectorAll('#join-pin .pin-digit');
    
    inputs.forEach((input, index) => {
        input.value = '';
        input.classList.remove('filled');
        
        input.addEventListener('input', (e) => {
        const val = e.target.value.replace(/[^0-9]/g, '');
        e.target.value = val.slice(0, 1);
        
        if (val && index < 5) {
            inputs[index + 1].focus();
        }
        
        input.classList.toggle('filled', val.length > 0);
        });
        
        input.addEventListener('keydown', (e) => {
        if (e.key === 'Backspace' && !e.target.value && index > 0) {
            inputs[index - 1].focus();
        }
        });
    });
    
    // Focus first input
    inputs[0].focus();
    }

    function getEnteredPin() {
    const inputs = document.querySelectorAll('#join-pin .pin-digit');
    return Array.from(inputs).map(i => i.value).join('');
    }

    function showStatus(message, type = 'info') {
    const status = document.getElementById('setup-status');
    status.textContent = message;
    status.className = `status ${type}`;
    status.classList.remove('hidden');
    }

    function hideStatus() {
    document.getElementById('setup-status').classList.add('hidden');
    }

    async function performSetupAction() {
    const btn = document.getElementById('setup-action-btn');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner"></span> Working...';
    
    try {
        if (state.mode === 'create') {
        await doCreateRoom();
        } else {
        await doJoinRoom();
        }
    } catch (e) {
        showStatus(e.message || 'Operation failed', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = state.mode === 'create' ? 'Create Room' : 'Join Room';
    }
    }

    async function doCreateRoom() {
    const roomHash = await roomIdToHash(state.selectedEmojis);
    
    showStatus('Creating room...', 'info');
    
    const response = await createRoom(roomHash, state.keyMode);
    
    // Store session info
    state.roomHash = roomHash;
    state.roomEmojis = [...state.selectedEmojis];
    state.memberId = response.member_id;
    state.createdAt = response.created_at;
    state.expiresAt = response.expires_at;
    state.nickname = 'creator';
    
    // Derive encryption key
    const pin = state.keyMode === 'fixed' ? state.fixedPin : await getCurrentPin(state.roomEmojis);
    state.encryptionKey = await getEncryptionKey(state.roomEmojis, pin, state.keyMode, state.createdAt);
    
    // Enter chat
    enterChat();
    }

    async function doJoinRoom() {
    // Validate inputs
    if (state.selectedEmojis.length !== 6) {
        showStatus('Select all 6 emojis', 'error');
        return;
    }
    
    const pin = getEnteredPin();
    if (pin.length !== 6) {
        showStatus('Enter all 6 PIN digits', 'error');
        return;
    }
    
    const roomHash = await roomIdToHash(state.selectedEmojis);
    
    showStatus('Joining room...', 'info');
    
    // Get room info first to determine mode
    let roomInfo;
    try {
        roomInfo = await getRoomInfo(roomHash);
    } catch (e) {
        showStatus('Room not found', 'error');
        return;
    }
    
    // Join the room
    const response = await joinRoom(roomHash, state.nickname);
    
    // Store session info
    state.roomHash = roomHash;
    state.roomEmojis = [...state.selectedEmojis];
    state.memberId = response.member_id;
    state.createdAt = response.created_at;
    state.expiresAt = response.expires_at;
    state.keyMode = response.mode;
    state.fixedPin = response.mode === 'fixed' ? pin : null;
    
    // Derive encryption key
    state.encryptionKey = await getEncryptionKey(state.roomEmojis, pin, state.keyMode, state.createdAt);
    
    // Enter chat
    enterChat();
    }

    function enterChat() {
    state.mode = 'chat';
    state.messages = [];
    state.lastMessageTs = 0;
    state.isConnected = true;
    
    // Update chat header
    document.getElementById('chat-room-emojis').textContent = state.roomEmojis.join(' ');
    updateChatExpiry();
    
    // Clear messages
    document.getElementById('chat-messages').innerHTML = '';
    addSystemMessage('You joined the room. Messages are end-to-end encrypted.');
    
    // Setup connection status
    updateConnectionStatus(true);
    
    // Setup PIN overlay for creators
    if (state.keyMode === 'rotating') {
        setupPinOverlay();
    }
    
    // Start polling
    startPolling();
    
    // Focus message input
    document.getElementById('message-input').focus();
    
    // Setup enter key handler
    document.getElementById('message-input').onkeypress = (e) => {
        if (e.key === 'Enter') sendMessage();
    };
    
    showScreen('chat-screen');
    }

    function updateChatExpiry() {
    const expiry = document.getElementById('chat-expiry');
    const remaining = Math.max(0, Math.floor((state.expiresAt - Date.now() / 1000) / 60));
    expiry.textContent = `${remaining}m left`;
    }

    function updateConnectionStatus(connected) {
    state.isConnected = connected;
    const dot = document.getElementById('connection-dot');
    const text = document.getElementById('connection-text');
    
    dot.classList.remove('connected', 'error');
    if (connected) {
        dot.classList.add('connected');
        text.textContent = 'Connected';
    } else {
        dot.classList.add('error');
        text.textContent = 'Reconnecting...';
    }
    }

    function setupPinOverlay() {
    const overlay = document.getElementById('pin-overlay');
    
    async function updateOverlay() {
        if (state.keyMode !== 'rotating') {
        overlay.classList.remove('visible');
        return;
        }
        
        const pin = await getCurrentPin(state.roomEmojis);
        document.getElementById('overlay-pin').textContent = pin;
        document.getElementById('overlay-timer').textContent = getTimeRemaining();
        
        // Also update encryption key for new messages
        state.encryptionKey = await getEncryptionKey(state.roomEmojis, pin, state.keyMode, state.createdAt);
    }
    
    // Show overlay
    overlay.classList.add('visible');
    updateOverlay();
    
    // Update every second
    setInterval(updateOverlay, 1000);
    }

    function addSystemMessage(text) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = 'system-message';
    div.textContent = text;
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    }

    function addMessage(sender, content, timestamp, isOwn = false) {
    const container = document.getElementById('chat-messages');
    const div = document.createElement('div');
    div.className = `message${isOwn ? ' own' : ''}`;
    
    const time = new Date(timestamp * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    
    div.innerHTML = `
        <div class="message-sender">${escapeHtml(sender)}</div>
        <div class="message-content">${escapeHtml(content)}</div>
        <div class="message-time">${time}</div>
    `;
    
    container.appendChild(div);
    container.scrollTop = container.scrollHeight;
    }

    function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
    }

    async function sendMessage() {
    const input = document.getElementById('message-input');
    const message = input.value.trim();
    
    if (!message || message.length > CONFIG.MAX_MESSAGE_LENGTH) return;
    
    const btn = document.getElementById('send-btn');
    btn.disabled = true;
    
    try {
        // Encrypt message
        const encrypted = encryptMessage(message, state.encryptionKey);
        const encryptedBase64 = btoa(String.fromCharCode(...encrypted));
        
        // Send to server
        await sendMessageApi(state.roomHash, encryptedBase64, state.nickname, state.memberId);
        
        // Clear input (message will appear via polling)
        input.value = '';
        
    } catch (e) {
        console.error('Send failed:', e);
        addSystemMessage('Failed to send message');
    } finally {
        btn.disabled = false;
        input.focus();
    }
    }

    async function startPolling() {
    clearInterval(state.pollInterval);
    
    async function poll() {
        try {
        const response = await pollMessages(state.roomHash, state.lastMessageTs, state.memberId);
        
        // Update connection status
        if (!state.isConnected) {
            updateConnectionStatus(true);
            addSystemMessage('Reconnected');
        }
        
        // Update expiry
        state.expiresAt = response.expires_at;
        updateChatExpiry();
        
        // Process new messages
        for (const msg of response.messages) {
            if (msg.timestamp <= state.lastMessageTs) continue;
            
            // Decrypt message content
            const encryptedBytes = Uint8Array.from(atob(msg.content), c => c.charCodeAt(0));
            const decrypted = await tryDecrypt(encryptedBytes, state.roomEmojis, state.keyMode, state.createdAt);
            
            if (decrypted !== null) {
            const isOwn = msg.sender === state.nickname;
            addMessage(msg.sender, decrypted, msg.timestamp, isOwn);
            } else {
            addMessage(msg.sender, '[Could not decrypt]', msg.timestamp, false);
            }
            
            state.lastMessageTs = msg.timestamp;
        }
        
        // Update members count
        document.getElementById('chat-members').textContent = ` Â· ${response.members.length} online`;
        
        } catch (e) {
        console.error('Poll failed:', e);
        updateConnectionStatus(false);
        }
    }
    
    // Initial poll
    await poll();
    
    // Continue polling
    state.pollInterval = setInterval(poll, CONFIG.POLL_INTERVAL);
    }

    async function leaveRoom() {
    clearInterval(state.pollInterval);
    clearInterval(state.pinTimerInterval);
    
    try {
        await leaveRoomApi(state.roomHash, state.memberId);
    } catch (e) {
        console.error('Leave failed:', e);
    }
    
    // Reset state
    state.roomHash = null;
    state.roomEmojis = null;
    state.memberId = null;
    state.encryptionKey = null;
    state.messages = [];
    
    // Hide PIN overlay
    document.getElementById('pin-overlay').classList.remove('visible');
    
    showWelcome();
    }

    // Make functions available globally
    window.showWelcome = showWelcome;
    window.showCreateRoom = showCreateRoom;
    window.showJoinRoom = showJoinRoom;
    window.selectMode = selectMode;
    window.performSetupAction = performSetupAction;
    window.sendMessage = sendMessage;
    window.leaveRoom = leaveRoom;
    window.removeEmojiAt = removeEmojiAt;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
    console.log('SOS Web Client loaded');
    showWelcome();
    });

  </script>
</body>
</html>
