<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>SOS - Emergency Secure Chat</title>
  <meta name="description" content="End-to-end encrypted chat rooms over DNS tunnel. Works even during internet blackouts.">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üÜò</text></svg>">
  <style>
    /* ========================================
       SOS Emergency Chat - Minimal Dark Theme
       Matching DNSCloak design language
       ======================================== */
    
    :root {
      --font-main: 'SF Mono', Monaco, Consolas, 'Courier New', monospace;
      --bg-primary: #1a0a0a;
      --bg-secondary: #2a1515;
      --bg-tertiary: #3a2020;
      --bg-input: #251010;
      --text-primary: #e7e7e7;
      --text-secondary: #b0a0a0;
      --text-dim: #706060;
      --sos-red: #ff4444;
      --sos-red-dark: #cc2222;
      --sos-red-glow: rgba(255, 68, 68, 0.3);
      --sos-green: #44cc66;
      --sos-yellow: #e5c855;
      --border: #4a3030;
      --border-focus: #ff4444;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: var(--font-main);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      min-height: 100vh;
      min-height: 100dvh;
      font-size: 14px;
      overflow: hidden;
    }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-primary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--sos-red); }
    
    /* App Container */
    #app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
      max-width: 600px;
      margin: 0 auto;
      padding: 0;
    }
    
    /* Screen management */
    .screen { display: none; flex-direction: column; height: 100%; }
    .screen.active { display: flex; }
    
    /* ===== HEADER ===== */
    .header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 12px 16px;
      text-align: center;
      flex-shrink: 0;
    }
    
    .header-logo {
      color: var(--sos-red);
      font-size: 12px;
      line-height: 1.1;
      white-space: pre;
      margin-bottom: 4px;
    }
    
    .header-subtitle {
      color: var(--text-secondary);
      font-size: 11px;
    }
    
    /* ===== WELCOME SCREEN ===== */
    #welcome-screen .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding: 24px;
      gap: 20px;
    }
    
    .welcome-info {
      text-align: center;
      color: var(--text-secondary);
      font-size: 12px;
      max-width: 320px;
    }
    
    .welcome-info .icon { font-size: 48px; margin-bottom: 12px; }
    .welcome-info h2 { color: var(--text-primary); margin-bottom: 8px; font-size: 16px; }
    
    .feature-list {
      margin-top: 16px;
      text-align: left;
      font-size: 11px;
    }
    
    .feature-list li {
      margin: 6px 0;
      list-style: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .feature-list .check { color: var(--sos-green); }
    
    /* Buttons */
    .btn {
      display: block;
      width: 100%;
      max-width: 280px;
      padding: 14px 20px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    
    .btn:hover {
      border-color: var(--sos-red);
      background: var(--bg-tertiary);
    }
    
    .btn:active { transform: scale(0.98); }
    
    .btn-primary {
      background: var(--sos-red-dark);
      border-color: var(--sos-red);
      color: white;
    }
    
    .btn-primary:hover {
      background: var(--sos-red);
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .btn-group {
      display: flex;
      flex-direction: column;
      gap: 12px;
      width: 100%;
      max-width: 280px;
    }
    
    /* ===== CREATE/JOIN SCREEN ===== */
    #setup-screen .content {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 20px;
      gap: 20px;
      overflow-y: auto;
    }
    
    .setup-section {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      padding: 16px;
    }
    
    .setup-section h3 {
      font-size: 12px;
      color: var(--text-secondary);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }
    
    /* Room ID display */
    .room-id-display {
      display: flex;
      justify-content: center;
      gap: 8px;
      font-size: 28px;
      padding: 16px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      margin-bottom: 8px;
      flex-wrap: wrap;
    }
    
    .room-id-phonetic {
      text-align: center;
      color: var(--text-dim);
      font-size: 11px;
    }
    
    /* Emoji Picker */
    .emoji-picker {
      display: grid;
      grid-template-columns: repeat(8, 1fr);
      gap: 4px;
      margin-bottom: 12px;
    }
    
    .emoji-btn {
      aspect-ratio: 1;
      border: 1px solid var(--border);
      background: var(--bg-input);
      font-size: 20px;
      cursor: pointer;
      transition: all 0.1s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .emoji-btn:hover { border-color: var(--sos-red); background: var(--bg-tertiary); }
    .emoji-btn.selected { border-color: var(--sos-red); background: var(--sos-red-dark); }
    
    .emoji-selected {
      display: flex;
      gap: 6px;
      font-size: 24px;
      padding: 12px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      min-height: 52px;
      flex-wrap: wrap;
      justify-content: center;
    }
    
    .emoji-selected span {
      cursor: pointer;
      transition: transform 0.1s;
    }
    
    .emoji-selected span:hover { transform: scale(1.2); }
    
    /* Mode selector */
    .mode-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 12px;
    }
    
    .mode-btn {
      flex: 1;
      padding: 12px 8px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-secondary);
      font-family: var(--font-main);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
      text-align: center;
    }
    
    .mode-btn:hover { border-color: var(--text-secondary); }
    .mode-btn.active {
      border-color: var(--sos-red);
      background: var(--sos-red-dark);
      color: white;
    }
    
    .mode-btn .icon { font-size: 16px; display: block; margin-bottom: 4px; }
    
    /* PIN display/input */
    .pin-display, .pin-input-group {
      display: flex;
      justify-content: center;
      gap: 6px;
      margin: 12px 0;
    }
    
    .pin-digit {
      width: 36px;
      height: 44px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      font-size: 20px;
      text-align: center;
      color: var(--text-primary);
      font-family: var(--font-main);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pin-digit.filled { border-color: var(--sos-red); }
    
    input.pin-digit {
      outline: none;
    }
    
    input.pin-digit:focus {
      border-color: var(--sos-red);
      box-shadow: 0 0 0 2px var(--sos-red-glow);
    }
    
    .pin-timer {
      text-align: center;
      color: var(--sos-yellow);
      font-size: 11px;
      margin-top: 8px;
    }
    
    .pin-timer.fixed { color: var(--text-dim); }
    
    /* Status messages */
    .status {
      padding: 8px 12px;
      font-size: 11px;
      text-align: center;
      border: 1px solid;
    }
    
    .status.error {
      background: rgba(255, 68, 68, 0.1);
      border-color: var(--sos-red);
      color: var(--sos-red);
    }
    
    .status.success {
      background: rgba(68, 204, 102, 0.1);
      border-color: var(--sos-green);
      color: var(--sos-green);
    }
    
    .status.info {
      background: rgba(229, 200, 85, 0.1);
      border-color: var(--sos-yellow);
      color: var(--sos-yellow);
    }
    
    /* Footer actions */
    .setup-actions {
      display: flex;
      gap: 12px;
      padding: 16px 20px;
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    
    .setup-actions .btn { max-width: none; }
    
    /* ===== CHAT SCREEN ===== */
    #chat-screen {
      display: none;
      flex-direction: column;
      height: 100%;
    }
    
    #chat-screen.active { display: flex; }
    
    .chat-header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 10px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    
    .chat-room-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .chat-room-emojis { font-size: 14px; }
    
    .chat-room-meta {
      font-size: 10px;
      color: var(--text-secondary);
    }
    
    .chat-room-meta .expiry { color: var(--sos-yellow); }
    
    .chat-status {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 10px;
    }
    
    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--text-dim);
    }
    
    .status-dot.connected { background: var(--sos-green); }
    .status-dot.error { background: var(--sos-red); }
    
    /* Messages */
    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 12px 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .message {
      max-width: 85%;
      padding: 8px 12px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      font-size: 13px;
      word-wrap: break-word;
    }
    
    .message.own {
      align-self: flex-end;
      background: var(--sos-red-dark);
      border-color: var(--sos-red);
    }
    
    .message-sender {
      font-size: 10px;
      color: var(--text-secondary);
      margin-bottom: 2px;
    }
    
    .message.own .message-sender { color: rgba(255,255,255,0.7); }
    
    .message-time {
      font-size: 9px;
      color: var(--text-dim);
      text-align: right;
      margin-top: 4px;
    }
    
    .message.own .message-time { color: rgba(255,255,255,0.5); }
    
    .system-message {
      text-align: center;
      color: var(--text-dim);
      font-size: 11px;
      padding: 8px;
    }
    
    /* Chat input */
    .chat-input-area {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    
    .chat-input {
      flex: 1;
      padding: 10px 12px;
      border: 1px solid var(--border);
      background: var(--bg-input);
      color: var(--text-primary);
      font-family: var(--font-main);
      font-size: 13px;
      outline: none;
    }
    
    .chat-input:focus {
      border-color: var(--sos-red);
    }
    
    .chat-input::placeholder { color: var(--text-dim); }
    
    .send-btn {
      padding: 10px 20px;
      background: var(--sos-red-dark);
      border: 1px solid var(--sos-red);
      color: white;
      font-family: var(--font-main);
      font-size: 13px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .send-btn:hover { background: var(--sos-red); }
    .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    
    /* PIN overlay for rotating mode */
    .pin-overlay {
      position: fixed;
      bottom: 70px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--bg-secondary);
      border: 1px solid var(--sos-yellow);
      padding: 8px 16px;
      font-size: 11px;
      color: var(--sos-yellow);
      z-index: 100;
      display: none;
    }
    
    .pin-overlay.visible { display: block; }
    
    /* Back button */
    .back-btn {
      background: none;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 18px;
      padding: 4px 8px;
      margin-right: 8px;
    }
    
    .back-btn:hover { color: var(--sos-red); }
    
    /* Loading spinner */
    .spinner {
      display: inline-block;
      width: 14px;
      height: 14px;
      border: 2px solid var(--text-dim);
      border-top-color: var(--sos-red);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 400px) {
      .emoji-picker { grid-template-columns: repeat(6, 1fr); }
      .room-id-display { font-size: 24px; gap: 6px; }
      .emoji-btn { font-size: 18px; }
    }
    
    /* Hidden utility */
    .hidden { display: none !important; }
  </style>
</head>
<body>
  <div id="app">
    <!-- ===== WELCOME SCREEN ===== -->
    <section id="welcome-screen" class="screen active">
      <header class="header">
        <pre class="header-logo">‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïó ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïó ‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïó
‚ñí‚ñí‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù‚ñí‚ñí‚ïî‚ïê‚ïê‚ïê‚ñí‚ñí‚ïó‚ñí‚ñí‚ïî‚ïê‚ïê‚ïê‚ïê‚ïù
‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïó‚ñí‚ñí‚ïë   ‚ñí‚ñí‚ïë‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïó
‚ïö‚ïê‚ïê‚ïê‚ïê‚ñí‚ñí‚ïë‚ñí‚ñí‚ïë   ‚ñí‚ñí‚ïë‚ïö‚ïê‚ïê‚ïê‚ïê‚ñí‚ñí‚ïë
‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïë‚ïö‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïî‚ïù‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ñí‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù ‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù</pre>
        <div class="header-subtitle">Emergency Secure Chat</div>
      </header>
      
      <div class="content">
        <div class="welcome-info">
          <div class="icon">üîê</div>
          <h2>Private Rooms via DNS Tunnel</h2>
          <p>End-to-end encrypted chat that works even when the internet is blocked.</p>
          
          <ul class="feature-list">
            <li><span class="check">‚úì</span> 6-emoji room ID + 6-digit PIN</li>
            <li><span class="check">‚úì</span> Rooms auto-wipe after 1 hour</li>
            <li><span class="check">‚úì</span> Works during internet blackouts</li>
            <li><span class="check">‚úì</span> No registration, no traces</li>
          </ul>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="showCreateRoom()">Create Room</button>
          <button class="btn" onclick="showJoinRoom()">Join Room</button>
        </div>
      </div>
    </section>
    
    <!-- ===== SETUP SCREEN (Create/Join) ===== -->
    <section id="setup-screen" class="screen">
      <header class="header" style="display: flex; align-items: center;">
        <button class="back-btn" onclick="showWelcome()">‚Üê</button>
        <div style="flex:1;">
          <div class="header-subtitle" id="setup-title">Create Room</div>
        </div>
      </header>
      
      <div class="content">
        <!-- Room ID Section -->
        <div class="setup-section">
          <h3>Room ID (6 Emojis)</h3>
          
          <!-- Create mode: display generated emojis -->
          <div id="create-room-id" class="hidden">
            <div class="room-id-display" id="room-emojis-display"></div>
            <div class="room-id-phonetic" id="room-phonetic"></div>
          </div>
          
          <!-- Join mode: emoji picker -->
          <div id="join-room-id" class="hidden">
            <div class="emoji-picker" id="emoji-picker"></div>
            <div class="emoji-selected" id="selected-emojis">
              <span style="color: var(--text-dim); font-size: 12px;">Click emojis above (need 6)</span>
            </div>
          </div>
        </div>
        
        <!-- Mode Section (Create only) -->
        <div class="setup-section" id="mode-section">
          <h3>Key Mode</h3>
          <div class="mode-selector">
            <button class="mode-btn active" data-mode="rotating" onclick="selectMode('rotating')">
              <span class="icon">üîÑ</span>
              Rotating
              <small style="display:block; font-size:9px; color:var(--text-dim);">Changes every 15s</small>
            </button>
            <button class="mode-btn" data-mode="fixed" onclick="selectMode('fixed')">
              <span class="icon">üìå</span>
              Fixed
              <small style="display:block; font-size:9px; color:var(--text-dim);">Static PIN</small>
            </button>
          </div>
        </div>
        
        <!-- PIN Section -->
        <div class="setup-section">
          <h3 id="pin-section-title">PIN</h3>
          
          <!-- Create mode: display PIN -->
          <div id="create-pin" class="hidden">
            <div class="pin-display" id="pin-display"></div>
            <div class="pin-timer" id="pin-timer">Refreshes in 15s</div>
          </div>
          
          <!-- Join mode: PIN input -->
          <div id="join-pin" class="hidden">
            <div class="pin-input-group">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="0">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="1">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="2">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="3">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="4">
              <input type="text" class="pin-digit" maxlength="1" inputmode="numeric" pattern="[0-9]" data-index="5">
            </div>
          </div>
        </div>
        
        <!-- Status -->
        <div id="setup-status" class="status hidden"></div>
      </div>
      
      <div class="setup-actions">
        <button class="btn" onclick="showWelcome()">Cancel</button>
        <button class="btn btn-primary" id="setup-action-btn" onclick="performSetupAction()">
          Create Room
        </button>
      </div>
    </section>
    
    <!-- ===== CHAT SCREEN ===== -->
    <section id="chat-screen" class="screen">
      <header class="chat-header">
        <div class="chat-room-info">
          <button class="back-btn" onclick="leaveRoom()">‚Üê</button>
          <div>
            <div class="chat-room-emojis" id="chat-room-emojis"></div>
            <div class="chat-room-meta">
              <span class="expiry" id="chat-expiry"></span>
              <span id="chat-members"></span>
            </div>
          </div>
        </div>
        <div class="chat-status">
          <span class="status-dot" id="connection-dot"></span>
          <span id="connection-text">Connecting...</span>
        </div>
      </header>
      
      <div class="chat-messages" id="chat-messages"></div>
      
      <!-- PIN overlay for sharing with joiners -->
      <div class="pin-overlay" id="pin-overlay">
        Current PIN: <strong id="overlay-pin"></strong> (refreshes in <span id="overlay-timer"></span>s)
      </div>
      
      <div class="chat-input-area">
        <input type="text" class="chat-input" id="message-input" placeholder="Type a message..." maxlength="2000">
        <button class="send-btn" id="send-btn" onclick="sendMessage()">Send</button>
      </div>
    </section>
  </div>
  
  <!-- TweetNaCl.js (inlined for offline use) -->
  <script>
    /*! TweetNaCl.js - Public Domain - https://tweetnacl.js.org/ - @dchest */
    !function(i){"use strict";var m=function(r,n){this.hi=0|r,this.lo=0|n},v=function(r){var n,e=new Float64Array(16);if(r)for(n=0;n<r.length;n++)e[n]=r[n];return e},a=function(){throw new Error("no PRNG")},o=new Uint8Array(16),e=new Uint8Array(32);e[0]=9;var c=v(),w=v([1]),g=v([56129,1]),y=v([30883,4953,19914,30187,55467,16705,2637,112,59544,30585,16505,36039,65139,11119,27886,20995]),l=v([61785,9906,39828,60374,45398,33411,5274,224,53552,61171,33010,6542,64743,22239,55772,9222]),t=v([54554,36645,11616,51542,42930,38181,51040,26924,56412,64982,57905,49316,21502,52590,14035,8553]),f=v([26200,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214,26214]),s=v([41136,18958,6951,50414,58488,44335,6150,12099,55207,15867,153,11085,57099,20417,9344,11139]);function h(r,n){return r<<n|r>>>32-n}function b(r,n){var e=255&r[n+3];return(e=(e=e<<8|255&r[n+2])<<8|255&r[n+1])<<8|255&r[n+0]}function B(r,n){var e=r[n]<<24|r[n+1]<<16|r[n+2]<<8|r[n+3],t=r[n+4]<<24|r[n+5]<<16|r[n+6]<<8|r[n+7];return new m(e,t)}function p(r,n,e){var t;for(t=0;t<4;t++)r[n+t]=255&e,e>>>=8}function S(r,n,e){r[n]=e.hi>>24&255,r[n+1]=e.hi>>16&255,r[n+2]=e.hi>>8&255,r[n+3]=255&e.hi,r[n+4]=e.lo>>24&255,r[n+5]=e.lo>>16&255,r[n+6]=e.lo>>8&255,r[n+7]=255&e.lo}function u(r,n,e,t,o){var i,a=0;for(i=0;i<o;i++)a|=r[n+i]^e[t+i];return(1&a-1>>>8)-1}function A(r,n,e,t){return u(r,n,e,t,16)}function _(r,n,e,t){return u(r,n,e,t,32)}function U(r,n,e,t,o){var i,a,f,u=new Uint32Array(16),c=new Uint32Array(16),w=new Uint32Array(16),y=new Uint32Array(4);for(i=0;i<4;i++)c[5*i]=b(t,4*i),c[1+i]=b(e,4*i),c[6+i]=b(n,4*i),c[11+i]=b(e,16+4*i);for(i=0;i<16;i++)w[i]=c[i];for(i=0;i<20;i++){for(a=0;a<4;a++){for(f=0;f<4;f++)y[f]=c[(5*a+4*f)%16];for(y[1]^=h(y[0]+y[3]|0,7),y[2]^=h(y[1]+y[0]|0,9),y[3]^=h(y[2]+y[1]|0,13),y[0]^=h(y[3]+y[2]|0,18),f=0;f<4;f++)u[4*a+(a+f)%4]=y[f]}for(f=0;f<16;f++)c[f]=u[f]}if(o){for(i=0;i<16;i++)c[i]=c[i]+w[i]|0;for(i=0;i<4;i++)c[5*i]=c[5*i]-b(t,4*i)|0,c[6+i]=c[6+i]-b(n,4*i)|0;for(i=0;i<4;i++)p(r,4*i,c[5*i]),p(r,16+4*i,c[6+i])}else for(i=0;i<16;i++)p(r,4*i,c[i]+w[i]|0)}function E(r,n,e,t){U(r,n,e,t,!1)}function x(r,n,e,t){return U(r,n,e,t,!0),0}var d=new Uint8Array([101,120,112,97,110,100,32,51,50,45,98,121,116,101,32,107]);function K(r,n,e,t,o,i,a){var f,u,c=new Uint8Array(16),w=new Uint8Array(64);if(!o)return 0;for(u=0;u<16;u++)c[u]=0;for(u=0;u<8;u++)c[u]=i[u];for(;64<=o;){for(E(w,c,a,d),u=0;u<64;u++)r[n+u]=(e?e[t+u]:0)^w[u];for(f=1,u=8;u<16;u++)f=f+(255&c[u])|0,c[u]=255&f,f>>>=8;o-=64,n+=64,e&&(t+=64)}if(0<o)for(E(w,c,a,d),u=0;u<o;u++)r[n+u]=(e?e[t+u]:0)^w[u];return 0}function Y(r,n,e,t,o){return K(r,n,null,0,e,t,o)}function L(r,n,e,t,o){var i=new Uint8Array(32);return x(i,t,o,d),Y(r,n,e,t.subarray(16),i)}function T(r,n,e,t,o,i,a){var f=new Uint8Array(32);return x(f,i,a,d),K(r,n,e,t,o,i.subarray(16),f)}function k(r,n){var e,t=0;for(e=0;e<17;e++)t=t+(r[e]+n[e]|0)|0,r[e]=255&t,t>>>=8}var z=new Uint32Array([5,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,252]);function R(r,n,e,t,o,i){var a,f,u,c,w=new Uint32Array(17),y=new Uint32Array(17),l=new Uint32Array(17),s=new Uint32Array(17),h=new Uint32Array(17);for(u=0;u<17;u++)y[u]=l[u]=0;for(u=0;u<16;u++)y[u]=i[u];for(y[3]&=15,y[4]&=252,y[7]&=15,y[8]&=252,y[11]&=15,y[12]&=252,y[15]&=15;0<o;){for(u=0;u<17;u++)s[u]=0;for(u=0;u<16&&u<o;++u)s[u]=e[t+u];for(s[u]=1,t+=u,o-=u,k(l,s),f=0;f<17;f++)for(u=w[f]=0;u<17;u++)w[f]=w[f]+l[u]*(u<=f?y[f-u]:320*y[f+17-u]|0)|0;for(f=0;f<17;f++)l[f]=w[f];for(u=c=0;u<16;u++)c=c+l[u]|0,l[u]=255&c,c>>>=8;for(c=c+l[16]|0,l[16]=3&c,c=5*(c>>>2)|0,u=0;u<16;u++)c=c+l[u]|0,l[u]=255&c,c>>>=8;c=c+l[16]|0,l[16]=c}for(u=0;u<17;u++)h[u]=l[u];for(k(l,z),a=0|-(l[16]>>>7),u=0;u<17;u++)l[u]^=a&(h[u]^l[u]);for(u=0;u<16;u++)s[u]=i[u+16];for(s[16]=0,k(l,s),u=0;u<16;u++)r[n+u]=l[u];return 0}function P(r,n,e,t,o,i){var a=new Uint8Array(16);return R(a,0,e,t,o,i),A(r,n,a,0)}function M(r,n,e,t,o){var i;if(e<32)return-1;for(T(r,0,n,0,e,t,o),R(r,16,r,32,e-32,r),i=0;i<16;i++)r[i]=0;return 0}function N(r,n,e,t,o){var i,a=new Uint8Array(32);if(e<32)return-1;if(L(a,0,32,t,o),0!==P(n,16,n,32,e-32,a))return-1;for(T(r,0,n,0,e,t,o),i=0;i<32;i++)r[i]=0;return 0}function O(r,n){var e;for(e=0;e<16;e++)r[e]=0|n[e]}function C(r){var n,e;for(e=0;e<16;e++)r[e]+=65536,n=Math.floor(r[e]/65536),r[(e+1)*(e<15?1:0)]+=n-1+37*(n-1)*(15===e?1:0),r[e]-=65536*n}function F(r,n,e){for(var t,o=~(e-1),i=0;i<16;i++)t=o&(r[i]^n[i]),r[i]^=t,n[i]^=t}function Z(r,n){var e,t,o,i=v(),a=v();for(e=0;e<16;e++)a[e]=n[e];for(C(a),C(a),C(a),t=0;t<2;t++){for(i[0]=a[0]-65517,e=1;e<15;e++)i[e]=a[e]-65535-(i[e-1]>>16&1),i[e-1]&=65535;i[15]=a[15]-32767-(i[14]>>16&1),o=i[15]>>16&1,i[14]&=65535,F(a,i,1-o)}for(e=0;e<16;e++)r[2*e]=255&a[e],r[2*e+1]=a[e]>>8}function G(r,n){var e=new Uint8Array(32),t=new Uint8Array(32);return Z(e,r),Z(t,n),_(e,0,t,0)}function q(r){var n=new Uint8Array(32);return Z(n,r),1&n[0]}function D(r,n){var e;for(e=0;e<16;e++)r[e]=n[2*e]+(n[2*e+1]<<8);r[15]&=32767}function I(r,n,e){var t;for(t=0;t<16;t++)r[t]=n[t]+e[t]|0}function V(r,n,e){var t;for(t=0;t<16;t++)r[t]=n[t]-e[t]|0}function X(r,n,e){var t,o,i=new Float64Array(31);for(t=0;t<31;t++)i[t]=0;for(t=0;t<16;t++)for(o=0;o<16;o++)i[t+o]+=n[t]*e[o];for(t=0;t<15;t++)i[t]+=38*i[t+16];for(t=0;t<16;t++)r[t]=i[t];C(r),C(r)}function j(r,n){X(r,n,n)}function H(r,n){var e,t=v();for(e=0;e<16;e++)t[e]=n[e];for(e=253;0<=e;e--)j(t,t),2!==e&&4!==e&&X(t,t,n);for(e=0;e<16;e++)r[e]=t[e]}function J(r,n){var e,t=v();for(e=0;e<16;e++)t[e]=n[e];for(e=250;0<=e;e--)j(t,t),1!==e&&X(t,t,n);for(e=0;e<16;e++)r[e]=t[e]}function Q(r,n,e){var t,o,i=new Uint8Array(32),a=new Float64Array(80),f=v(),u=v(),c=v(),w=v(),y=v(),l=v();for(o=0;o<31;o++)i[o]=n[o];for(i[31]=127&n[31]|64,i[0]&=248,D(a,e),o=0;o<16;o++)u[o]=a[o],w[o]=f[o]=c[o]=0;for(f[0]=w[0]=1,o=254;0<=o;--o)F(f,u,t=i[o>>>3]>>>(7&o)&1),F(c,w,t),I(y,f,c),V(f,f,c),I(c,u,w),V(u,u,w),j(w,y),j(l,f),X(f,c,f),X(c,u,y),I(y,f,c),V(f,f,c),j(u,f),V(c,w,l),X(f,c,g),I(f,f,w),X(c,c,f),X(f,w,l),X(w,u,a),j(u,y),F(f,u,t),F(c,w,t);for(o=0;o<16;o++)a[o+16]=f[o],a[o+32]=c[o],a[o+48]=u[o],a[o+64]=w[o];var s=a.subarray(32),h=a.subarray(16);return H(s,s),X(h,h,s),Z(r,h),0}function W(r,n){return Q(r,n,e)}function $(r,n){return a(n,32),W(r,n)}function rr(r,n,e){var t=new Uint8Array(32);return Q(t,e,n),x(r,o,t,d)}var nr=M,er=N;function tr(){var r,n,e,t=0,o=0,i=0,a=0,f=65535;for(e=0;e<arguments.length;e++)t+=(r=arguments[e].lo)&f,o+=r>>>16,i+=(n=arguments[e].hi)&f,a+=n>>>16;return new m((i+=(o+=t>>>16)>>>16)&f|(a+=i>>>16)<<16,t&f|o<<16)}function or(r,n){return new m(r.hi>>>n,r.lo>>>n|r.hi<<32-n)}function ir(){var r,n=0,e=0;for(r=0;r<arguments.length;r++)n^=arguments[r].lo,e^=arguments[r].hi;return new m(e,n)}function ar(r,n){var e,t,o=32-n;return n<32?(e=r.hi>>>n|r.lo<<o,t=r.lo>>>n|r.hi<<o):n<64&&(e=r.lo>>>n|r.hi<<o,t=r.hi>>>n|r.lo<<o),new m(e,t)}var fr=[new m(1116352408,3609767458),new m(1899447441,602891725),new m(3049323471,3964484399),new m(3921009573,2173295548),new m(961987163,4081628472),new m(1508970993,3053834265),new m(2453635748,2937671579),new m(2870763221,3664609560),new m(3624381080,2734883394),new m(310598401,1164996542),new m(607225278,1323610764),new m(1426881987,3590304994),new m(1925078388,4068182383),new m(2162078206,991336113),new m(2614888103,633803317),new m(3248222580,3479774868),new m(3835390401,2666613458),new m(4022224774,944711139),new m(264347078,2341262773),new m(604807628,2007800933),new m(770255983,1495990901),new m(1249150122,1856431235),new m(1555081692,3175218132),new m(1996064986,2198950837),new m(2554220882,3999719339),new m(2821834349,766784016),new m(2952996808,2566594879),new m(3210313671,3203337956),new m(3336571891,1034457026),new m(3584528711,2466948901),new m(113926993,3758326383),new m(338241895,168717936),new m(666307205,1188179964),new m(773529912,1546045734),new m(1294757372,1522805485),new m(1396182291,2643833823),new m(1695183700,2343527390),new m(1986661051,1014477480),new m(2177026350,1206759142),new m(2456956037,344077627),new m(2730485921,1290863460),new m(2820302411,3158454273),new m(3259730800,3505952657),new m(3345764771,106217008),new m(3516065817,3606008344),new m(3600352804,1432725776),new m(4094571909,1467031594),new m(275423344,851169720),new m(430227734,3100823752),new m(506948616,1363258195),new m(659060556,3750685593),new m(883997877,3785050280),new m(958139571,3318307427),new m(1322822218,3812723403),new m(1537002063,2003034995),new m(1747873779,3602036899),new m(1955562222,1575990012),new m(2024104815,1125592928),new m(2227730452,2716904306),new m(2361852424,442776044),new m(2428436474,593698344),new m(2756734187,3733110249),new m(3204031479,2999351573),new m(3329325298,3815920427),new m(3391569614,3928383900),new m(3515267271,566280711),new m(3940187606,3454069534),new m(4118630271,4000239992),new m(116418474,1914138554),new m(174292421,2731055270),new m(289380356,3203993006),new m(460393269,320620315),new m(685471733,587496836),new m(852142971,1086792851),new m(1017036298,365543100),new m(1126000580,2618297676),new m(1288033470,3409855158),new m(1501505948,4234509866),new m(1607167915,987167468),new m(1816402316,1246189591)];function ur(r,n,e){var t,o,i,a=[],f=[],u=[],c=[];for(o=0;o<8;o++)a[o]=u[o]=B(r,8*o);for(var w,y,l,s,h,v,g,b,p,A,_,U,E,x,d=0;128<=e;){for(o=0;o<16;o++)c[o]=B(n,8*o+d);for(o=0;o<80;o++){for(i=0;i<8;i++)f[i]=u[i];for(t=tr(u[7],ir(ar(x=u[4],14),ar(x,18),ar(x,41)),(p=u[4],A=u[5],_=u[6],0,U=p.hi&A.hi^~p.hi&_.hi,E=p.lo&A.lo^~p.lo&_.lo,new m(U,E)),fr[o],c[o%16]),f[7]=tr(t,ir(ar(b=u[0],28),ar(b,34),ar(b,39)),(l=u[0],s=u[1],h=u[2],0,v=l.hi&s.hi^l.hi&h.hi^s.hi&h.hi,g=l.lo&s.lo^l.lo&h.lo^s.lo&h.lo,new m(v,g))),f[3]=tr(f[3],t),i=0;i<8;i++)u[(i+1)%8]=f[i];if(o%16==15)for(i=0;i<16;i++)c[i]=tr(c[i],c[(i+9)%16],ir(ar(y=c[(i+1)%16],1),ar(y,8),or(y,7)),ir(ar(w=c[(i+14)%16],19),ar(w,61),or(w,6)))}for(o=0;o<8;o++)u[o]=tr(u[o],a[o]),a[o]=u[o];d+=128,e-=128}for(o=0;o<8;o++)S(r,8*o,a[o]);return e}var cr=new Uint8Array([106,9,230,103,243,188,201,8,187,103,174,133,132,202,167,59,60,110,243,114,254,148,248,43,165,79,245,58,95,29,54,241,81,14,82,127,173,230,130,209,155,5,104,140,43,62,108,31,31,131,217,171,251,65,189,107,91,224,205,25,19,126,33,121]);function wr(r,n,e){var t,o=new Uint8Array(64),i=new Uint8Array(256),a=e;for(t=0;t<64;t++)o[t]=cr[t];for(ur(o,n,e),e%=128,t=0;t<256;t++)i[t]=0;for(t=0;t<e;t++)i[t]=n[a-e+t];for(i[e]=128,i[(e=256-128*(e<112?1:0))-9]=0,S(i,e-8,new m(a/536870912|0,a<<3)),ur(o,i,e),t=0;t<64;t++)r[t]=o[t];return 0}function yr(r,n){var e=v(),t=v(),o=v(),i=v(),a=v(),f=v(),u=v(),c=v(),w=v();V(e,r[1],r[0]),V(w,n[1],n[0]),X(e,e,w),I(t,r[0],r[1]),I(w,n[0],n[1]),X(t,t,w),X(o,r[3],n[3]),X(o,o,l),X(i,r[2],n[2]),I(i,i,i),V(a,t,e),V(f,i,o),I(u,i,o),I(c,t,e),X(r[0],a,f),X(r[1],c,u),X(r[2],u,f),X(r[3],a,c)}function lr(r,n,e){var t;for(t=0;t<4;t++)F(r[t],n[t],e)}function sr(r,n){var e=v(),t=v(),o=v();H(o,n[2]),X(e,n[0],o),X(t,n[1],o),Z(r,t),r[31]^=q(e)<<7}function hr(r,n,e){var t,o;for(O(r[0],c),O(r[1],w),O(r[2],w),O(r[3],c),o=255;0<=o;--o)lr(r,n,t=e[o/8|0]>>(7&o)&1),yr(n,r),yr(r,r),lr(r,n,t)}function vr(r,n){var e=[v(),v(),v(),v()];O(e[0],t),O(e[1],f),O(e[2],w),X(e[3],t,f),hr(r,e,n)}function gr(r,n,e){var t,o=new Uint8Array(64),i=[v(),v(),v(),v()];for(e||a(n,32),wr(o,n,32),o[0]&=248,o[31]&=127,o[31]|=64,vr(i,o),sr(r,i),t=0;t<32;t++)n[t+32]=r[t];return 0}var br=new Float64Array([237,211,245,92,26,99,18,88,214,156,247,162,222,249,222,20,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,16]);function pr(r,n){var e,t,o,i;for(t=63;32<=t;--t){for(e=0,o=t-32,i=t-12;o<i;++o)n[o]+=e-16*n[t]*br[o-(t-32)],e=Math.floor((n[o]+128)/256),n[o]-=256*e;n[o]+=e,n[t]=0}for(o=e=0;o<32;o++)n[o]+=e-(n[31]>>4)*br[o],e=n[o]>>8,n[o]&=255;for(o=0;o<32;o++)n[o]-=e*br[o];for(t=0;t<32;t++)n[t+1]+=n[t]>>8,r[t]=255&n[t]}function Ar(r){var n,e=new Float64Array(64);for(n=0;n<64;n++)e[n]=r[n];for(n=0;n<64;n++)r[n]=0;pr(r,e)}function _r(r,n,e,t){var o,i,a=new Uint8Array(64),f=new Uint8Array(64),u=new Uint8Array(64),c=new Float64Array(64),w=[v(),v(),v(),v()];wr(a,t,32),a[0]&=248,a[31]&=127,a[31]|=64;var y=e+64;for(o=0;o<e;o++)r[64+o]=n[o];for(o=0;o<32;o++)r[32+o]=a[32+o];for(wr(u,r.subarray(32),e+32),Ar(u),vr(w,u),sr(r,w),o=32;o<64;o++)r[o]=t[o];for(wr(f,r,e+64),Ar(f),o=0;o<64;o++)c[o]=0;for(o=0;o<32;o++)c[o]=u[o];for(o=0;o<32;o++)for(i=0;i<32;i++)c[o+i]+=f[o]*a[i];return pr(r.subarray(32),c),y}function Ur(r,n,e,t){var o,i=new Uint8Array(32),a=new Uint8Array(64),f=[v(),v(),v(),v()],u=[v(),v(),v(),v()];if(e<64)return-1;if(function(r,n){var e=v(),t=v(),o=v(),i=v(),a=v(),f=v(),u=v();if(O(r[2],w),D(r[1],n),j(o,r[1]),X(i,o,y),V(o,o,r[2]),I(i,r[2],i),j(a,i),j(f,a),X(u,f,a),X(e,u,o),X(e,e,i),J(e,e),X(e,e,o),X(e,e,i),X(e,e,i),X(r[0],e,i),j(t,r[0]),X(t,t,i),G(t,o)&&X(r[0],r[0],s),j(t,r[0]),X(t,t,i),G(t,o))return 1;q(r[0])===n[31]>>7&&V(r[0],c,r[0]),X(r[3],r[0],r[1])}(u,t))return-1;for(o=0;o<e;o++)r[o]=n[o];for(o=0;o<32;o++)r[o+32]=t[o];if(wr(a,r,e),Ar(a),hr(f,u,a),vr(u,n.subarray(32)),yr(f,u),sr(i,f),e-=64,_(n,0,i,0)){for(o=0;o<e;o++)r[o]=0;return-1}for(o=0;o<e;o++)r[o]=n[o+64];return e}function Er(r,n){if(32!==r.length)throw new Error("bad key size");if(24!==n.length)throw new Error("bad nonce size")}function xr(){for(var r=0;r<arguments.length;r++)if(!(arguments[r]instanceof Uint8Array))throw new TypeError("unexpected type, use Uint8Array")}function dr(r){for(var n=0;n<r.length;n++)r[n]=0}i.lowlevel={crypto_core_hsalsa20:x,crypto_stream_xor:T,crypto_stream:L,crypto_stream_salsa20_xor:K,crypto_stream_salsa20:Y,crypto_onetimeauth:R,crypto_onetimeauth_verify:P,crypto_verify_16:A,crypto_verify_32:_,crypto_secretbox:M,crypto_secretbox_open:N,crypto_scalarmult:Q,crypto_scalarmult_base:W,crypto_box_beforenm:rr,crypto_box_afternm:nr,crypto_box:function(r,n,e,t,o,i){var a=new Uint8Array(32);return rr(a,o,i),nr(r,n,e,t,a)},crypto_box_open:function(r,n,e,t,o,i){var a=new Uint8Array(32);return rr(a,o,i),er(r,n,e,t,a)},crypto_box_keypair:$,crypto_hash:wr,crypto_sign:_r,crypto_sign_keypair:gr,crypto_sign_open:Ur,crypto_secretbox_KEYBYTES:32,crypto_secretbox_NONCEBYTES:24,crypto_secretbox_ZEROBYTES:32,crypto_secretbox_BOXZEROBYTES:16,crypto_scalarmult_BYTES:32,crypto_scalarmult_SCALARBYTES:32,crypto_box_PUBLICKEYBYTES:32,crypto_box_SECRETKEYBYTES:32,crypto_box_BEFORENMBYTES:32,crypto_box_NONCEBYTES:24,crypto_box_ZEROBYTES:32,crypto_box_BOXZEROBYTES:16,crypto_sign_BYTES:64,crypto_sign_PUBLICKEYBYTES:32,crypto_sign_SECRETKEYBYTES:64,crypto_sign_SEEDBYTES:32,crypto_hash_BYTES:64,gf:v,D:y,L:br,pack25519:Z,unpack25519:D,M:X,A:I,S:j,Z:V,pow2523:J,add:yr,set25519:O,modL:pr,scalarmult:hr,scalarbase:vr},i.randomBytes=function(r){var n=new Uint8Array(r);return a(n,r),n},i.secretbox=function(r,n,e){xr(r,n,e),Er(e,n);for(var t=new Uint8Array(32+r.length),o=new Uint8Array(t.length),i=0;i<r.length;i++)t[i+32]=r[i];return M(o,t,t.length,n,e),o.subarray(16)},i.secretbox.open=function(r,n,e){xr(r,n,e),Er(e,n);for(var t=new Uint8Array(16+r.length),o=new Uint8Array(t.length),i=0;i<r.length;i++)t[i+16]=r[i];return t.length<32||0!==N(o,t,t.length,n,e)?null:o.subarray(32)},i.secretbox.keyLength=32,i.secretbox.nonceLength=24,i.secretbox.overheadLength=16,i.scalarMult=function(r,n){if(xr(r,n),32!==r.length)throw new Error("bad n size");if(32!==n.length)throw new Error("bad p size");var e=new Uint8Array(32);return Q(e,r,n),e},i.scalarMult.base=function(r){if(xr(r),32!==r.length)throw new Error("bad n size");var n=new Uint8Array(32);return W(n,r),n},i.scalarMult.scalarLength=32,i.scalarMult.groupElementLength=32,i.box=function(r,n,e,t){var o=i.box.before(e,t);return i.secretbox(r,n,o)},i.box.before=function(r,n){xr(r,n),function(r,n){if(32!==r.length)throw new Error("bad public key size");if(32!==n.length)throw new Error("bad secret key size")}(r,n);var e=new Uint8Array(32);return rr(e,r,n),e},i.box.after=i.secretbox,i.box.open=function(r,n,e,t){var o=i.box.before(e,t);return i.secretbox.open(r,n,o)},i.box.open.after=i.secretbox.open,i.box.keyPair=function(){var r=new Uint8Array(32),n=new Uint8Array(32);return $(r,n),{publicKey:r,secretKey:n}},i.box.keyPair.fromSecretKey=function(r){if(xr(r),32!==r.length)throw new Error("bad secret key size");var n=new Uint8Array(32);return W(n,r),{publicKey:n,secretKey:new Uint8Array(r)}},i.box.publicKeyLength=32,i.box.secretKeyLength=32,i.box.sharedKeyLength=32,i.box.nonceLength=24,i.box.overheadLength=i.secretbox.overheadLength,i.sign=function(r,n){if(xr(r,n),64!==n.length)throw new Error("bad secret key size");var e=new Uint8Array(64+r.length);return _r(e,r,r.length,n),e},i.sign.open=function(r,n){if(xr(r,n),32!==n.length)throw new Error("bad public key size");var e=new Uint8Array(r.length),t=Ur(e,r,r.length,n);if(t<0)return null;for(var o=new Uint8Array(t),i=0;i<o.length;i++)o[i]=e[i];return o},i.sign.detached=function(r,n){for(var e=i.sign(r,n),t=new Uint8Array(64),o=0;o<t.length;o++)t[o]=e[o];return t},i.sign.detached.verify=function(r,n,e){if(xr(r,n,e),64!==n.length)throw new Error("bad signature size");if(32!==e.length)throw new Error("bad public key size");var t,o=new Uint8Array(64+r.length),i=new Uint8Array(64+r.length);for(t=0;t<64;t++)o[t]=n[t];for(t=0;t<r.length;t++)o[t+64]=r[t];return 0<=Ur(i,o,o.length,e)},i.sign.keyPair=function(){var r=new Uint8Array(32),n=new Uint8Array(64);return gr(r,n),{publicKey:r,secretKey:n}},i.sign.keyPair.fromSecretKey=function(r){if(xr(r),64!==r.length)throw new Error("bad secret key size");for(var n=new Uint8Array(32),e=0;e<n.length;e++)n[e]=r[32+e];return{publicKey:n,secretKey:new Uint8Array(r)}},i.sign.keyPair.fromSeed=function(r){if(xr(r),32!==r.length)throw new Error("bad seed size");for(var n=new Uint8Array(32),e=new Uint8Array(64),t=0;t<32;t++)e[t]=r[t];return gr(n,e,!0),{publicKey:n,secretKey:e}},i.sign.publicKeyLength=32,i.sign.secretKeyLength=64,i.sign.seedLength=32,i.sign.signatureLength=64,i.hash=function(r){xr(r);var n=new Uint8Array(64);return wr(n,r,r.length),n},i.hash.hashLength=64,i.verify=function(r,n){return xr(r,n),0!==r.length&&0!==n.length&&(r.length===n.length&&0===u(r,0,n,0,r.length))},i.setPRNG=function(r){a=r},function(){var o="undefined"!=typeof self?self.crypto||self.msCrypto:null;if(o&&o.getRandomValues){i.setPRNG(function(r,n){var e,t=new Uint8Array(n);for(e=0;e<n;e+=65536)o.getRandomValues(t.subarray(e,e+Math.min(n-e,65536)));for(e=0;e<n;e++)r[e]=t[e];dr(t)})}else"undefined"!=typeof require&&(o=require("crypto"))&&o.randomBytes&&i.setPRNG(function(r,n){var e,t=o.randomBytes(n);for(e=0;e<n;e++)r[e]=t[e];dr(t)})}()}("undefined"!=typeof module&&module.exports?module.exports:self.nacl=self.nacl||{});
  </script>
  
  <!-- Argon2 WASM (minimal inline loader) -->
  <script>
  // Argon2 browser implementation with pure JS PBKDF2 fallback
  // Works in HTTP contexts where crypto.subtle is unavailable
  
  // Pure JS HMAC-SHA256 for PBKDF2
  function hmacSha256(key, message) {
    const blockSize = 64;
    const hashSize = 32;
    
    // If key is longer than block size, hash it
    if (key.length > blockSize) {
      key = sha256Sync(key);
    }
    
    // Pad key to block size
    const paddedKey = new Uint8Array(blockSize);
    paddedKey.set(key);
    
    // Create inner and outer pads
    const ipad = new Uint8Array(blockSize);
    const opad = new Uint8Array(blockSize);
    for (let i = 0; i < blockSize; i++) {
      ipad[i] = paddedKey[i] ^ 0x36;
      opad[i] = paddedKey[i] ^ 0x5c;
    }
    
    // Inner hash: H(ipad || message)
    const inner = new Uint8Array(blockSize + message.length);
    inner.set(ipad);
    inner.set(message, blockSize);
    const innerHash = sha256Sync(inner);
    
    // Outer hash: H(opad || inner_hash)
    const outer = new Uint8Array(blockSize + hashSize);
    outer.set(opad);
    outer.set(innerHash, blockSize);
    
    return sha256Sync(outer);
  }
  
  // Synchronous SHA256 (same as app.js fallback)
  function sha256Sync(message) {
    const K = new Uint32Array([
      0x428a2f98, 0x71374491, 0xb5c0fbcf, 0xe9b5dba5, 0x3956c25b, 0x59f111f1, 0x923f82a4, 0xab1c5ed5,
      0xd807aa98, 0x12835b01, 0x243185be, 0x550c7dc3, 0x72be5d74, 0x80deb1fe, 0x9bdc06a7, 0xc19bf174,
      0xe49b69c1, 0xefbe4786, 0x0fc19dc6, 0x240ca1cc, 0x2de92c6f, 0x4a7484aa, 0x5cb0a9dc, 0x76f988da,
      0x983e5152, 0xa831c66d, 0xb00327c8, 0xbf597fc7, 0xc6e00bf3, 0xd5a79147, 0x06ca6351, 0x14292967,
      0x27b70a85, 0x2e1b2138, 0x4d2c6dfc, 0x53380d13, 0x650a7354, 0x766a0abb, 0x81c2c92e, 0x92722c85,
      0xa2bfe8a1, 0xa81a664b, 0xc24b8b70, 0xc76c51a3, 0xd192e819, 0xd6990624, 0xf40e3585, 0x106aa070,
      0x19a4c116, 0x1e376c08, 0x2748774c, 0x34b0bcb5, 0x391c0cb3, 0x4ed8aa4a, 0x5b9cca4f, 0x682e6ff3,
      0x748f82ee, 0x78a5636f, 0x84c87814, 0x8cc70208, 0x90befffa, 0xa4506ceb, 0xbef9a3f7, 0xc67178f2
    ]);
    let H = new Uint32Array([0x6a09e667, 0xbb67ae85, 0x3c6ef372, 0xa54ff53a, 0x510e527f, 0x9b05688c, 0x1f83d9ab, 0x5be0cd19]);
    const rotr = (x, n) => (x >>> n) | (x << (32 - n));
    const ch = (x, y, z) => (x & y) ^ (~x & z);
    const maj = (x, y, z) => (x & y) ^ (x & z) ^ (y & z);
    const sigma0 = x => rotr(x, 2) ^ rotr(x, 13) ^ rotr(x, 22);
    const sigma1 = x => rotr(x, 6) ^ rotr(x, 11) ^ rotr(x, 25);
    const gamma0 = x => rotr(x, 7) ^ rotr(x, 18) ^ (x >>> 3);
    const gamma1 = x => rotr(x, 17) ^ rotr(x, 19) ^ (x >>> 10);
    const msgLen = message.length, bitLen = msgLen * 8;
    const padLen = ((msgLen + 8) % 64 === 0) ? 64 : 64 - ((msgLen + 8) % 64);
    const paddedLen = msgLen + 1 + padLen + 8;
    const padded = new Uint8Array(paddedLen);
    padded.set(message); padded[msgLen] = 0x80;
    const view = new DataView(padded.buffer);
    view.setUint32(paddedLen - 4, bitLen, false);
    const W = new Uint32Array(64);
    for (let offset = 0; offset < paddedLen; offset += 64) {
      for (let t = 0; t < 16; t++) W[t] = view.getUint32(offset + t * 4, false);
      for (let t = 16; t < 64; t++) W[t] = (gamma1(W[t-2]) + W[t-7] + gamma0(W[t-15]) + W[t-16]) >>> 0;
      let [a, b, c, d, e, f, g, h] = H;
      for (let t = 0; t < 64; t++) {
        const T1 = (h + sigma1(e) + ch(e, f, g) + K[t] + W[t]) >>> 0;
        const T2 = (sigma0(a) + maj(a, b, c)) >>> 0;
        h = g; g = f; f = e; e = (d + T1) >>> 0; d = c; c = b; b = a; a = (T1 + T2) >>> 0;
      }
      H[0] = (H[0] + a) >>> 0; H[1] = (H[1] + b) >>> 0; H[2] = (H[2] + c) >>> 0; H[3] = (H[3] + d) >>> 0;
      H[4] = (H[4] + e) >>> 0; H[5] = (H[5] + f) >>> 0; H[6] = (H[6] + g) >>> 0; H[7] = (H[7] + h) >>> 0;
    }
    const result = new Uint8Array(32);
    for (let i = 0; i < 8; i++) {
      result[i * 4] = (H[i] >>> 24) & 0xff; result[i * 4 + 1] = (H[i] >>> 16) & 0xff;
      result[i * 4 + 2] = (H[i] >>> 8) & 0xff; result[i * 4 + 3] = H[i] & 0xff;
    }
    return result;
  }
  
  // Pure JS PBKDF2-SHA256
  function pbkdf2Sha256(password, salt, iterations, keyLength) {
    const hashLen = 32;
    const numBlocks = Math.ceil(keyLength / hashLen);
    const result = new Uint8Array(keyLength);
    
    for (let block = 1; block <= numBlocks; block++) {
      // First iteration: U1 = HMAC(password, salt || INT(block))
      const saltBlock = new Uint8Array(salt.length + 4);
      saltBlock.set(salt);
      saltBlock[salt.length] = (block >>> 24) & 0xff;
      saltBlock[salt.length + 1] = (block >>> 16) & 0xff;
      saltBlock[salt.length + 2] = (block >>> 8) & 0xff;
      saltBlock[salt.length + 3] = block & 0xff;
      
      let U = hmacSha256(password, saltBlock);
      let T = new Uint8Array(U);
      
      // Subsequent iterations
      for (let i = 1; i < iterations; i++) {
        U = hmacSha256(password, U);
        for (let j = 0; j < hashLen; j++) T[j] ^= U[j];
      }
      
      // Copy to result
      const offset = (block - 1) * hashLen;
      const len = Math.min(hashLen, keyLength - offset);
      result.set(T.slice(0, len), offset);
    }
    
    return result;
  }
  
  window.argon2 = {
    ArgonType: { Argon2id: 2 },
    
    hash: async function(options) {
      const { pass, salt, time, mem, parallelism, hashLen, type } = options;
      const passBytes = typeof pass === 'string' ? new TextEncoder().encode(pass) : pass;
      const saltBytes = typeof salt === 'string' ? new TextEncoder().encode(salt) : salt;
      
      if (window._argon2_wasm) {
        return window._argon2_wasm.hash(options);
      }
      
      // Pure JS PBKDF2 fallback (works in HTTP)
      const iterations = time * 50000;
      const hash = pbkdf2Sha256(passBytes, saltBytes, iterations, hashLen);
      
      return {
        hash: hash,
        hashHex: Array.from(hash).map(b => b.toString(16).padStart(2, '0')).join('')
      };
    }
  };
  </script>
  
  <!-- App Logic -->
  <script src="app.js"></script>
</body>
</html>
